<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è–èª•å¤œçš„æ¶ˆå¤±é½’è¼ª</title>
    <style>
        /* --- ä¿®æ”¹é» 4ï¼šæ¥µç°¡åŒ–éŸ³æ¨‚æŒ‰éˆ• --- */
        #music-toggle {
            position: absolute;
            top: 15px;
            right: 15px; /* å›ºå®šåœ¨å³ä¸Šè§’ */
            width: 30px;
            height: 30px;
            /* ç§»é™¤èƒŒæ™¯è‰²å’Œé‚Šæ¡†ï¼Œåªç•™æ–‡å­—é¡è‰² */
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.3); /* é è¨­éå¸¸é€æ˜ä½èª¿ */
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 200; 
            font-size: 24px;
            transition: all 0.5s ease;
            user-select: none;
            outline: none;
        }

        #music-toggle:hover {
            color: rgba(78, 205, 196, 0.8); /* æ»‘é¼ ç¢°åˆ°æ™‚å¸¶é»ç§‘æŠ€è— */
            transform: scale(1.1);
            text-shadow: 0 0 8px rgba(78, 205, 196, 0.4);
        }

        /* --- è¦–è¦ºé¢¨æ ¼ --- */
        body {
            background-color: #050510;
            color: #e0e0e0;
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-image: radial-gradient(circle at center, #1a1a2e 0%, #000 100%);
        }

        #game-container {
            width: 1100px;
            height: 700px;
            background-color: rgba(30, 30, 35, 0.95);
            border: 1px solid #444;
            border-radius: 16px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            display: flex;
            position: relative; 
            overflow: hidden;
        }

        #visual-panel {
            flex: 6;
            position: relative;
            background-color: #111;
            background-size: cover;
            background-position: center;
            border-right: 2px solid #222;
            transition: opacity 0.4s ease-in-out;
            opacity: 1;
        }
        
        .fade-out {
            opacity: 0 !important;
        }

        .overlay-gradient {
            position: absolute;
            bottom: 0; left: 0; right: 0; height: 120px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            pointer-events: none;
        }

        #narrative-panel {
            flex: 4;
            display: flex;
            flex-direction: column;
            background-color: #1e1e24;
        }

        #header-bar {
            padding: 20px;
            background: #15151a;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        
        /* --- ä¿®æ”¹é» 1ï¼šç‹€æ…‹æ¬„å¾€å·¦ç§»ï¼Œé¿å…è·Ÿå³ä¸Šè§’çš„éŸ³æ¨‚æŒ‰éˆ•æ‰“æ¶ --- */
        #status-display {
            font-size: 13px; 
            color: #888;
            margin-right: 60px; /* å¼·åˆ¶å³é‚Šç•™ç™½ï¼Œé¿é–‹éŸ³æ¨‚æŒ‰éˆ• */
        }

        #scene-title { margin: 0; color: #d4af37; font-size: 20px; font-weight: bold; letter-spacing: 1px; }

        #feedback-area {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background-color: #25252b;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }
        #feedback-area::-webkit-scrollbar { width: 8px; }
        #feedback-area::-webkit-scrollbar-track { background: #222; }
        #feedback-area::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }

        @keyframes shake {
            0% { transform: translateX(0); }
            20% { transform: translateX(-4px) rotate(-1deg); }
            40% { transform: translateX(4px) rotate(1deg); }
            60% { transform: translateX(-4px) rotate(-1deg); }
            80% { transform: translateX(4px) rotate(1deg); }
            100% { transform: translateX(0); }
        }
        
        .shake {
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both !important;
            transform: translate3d(0, 0, 0); 
        }

        .bubble {
            max-width: 90%;
            padding: 12px 18px;
            border-radius: 16px;
            font-size: 16px;
            line-height: 1.6;
            position: relative;
            animation: slideUp 0.5s ease-out;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            word-wrap: break-word;
        }

        .bubble-system {
            align-self: center;
            background: rgba(255, 255, 255, 0.05);
            color: #bbb;
            font-size: 15px;
            text-align: center;
            border: 1px dashed #444;
            width: 95%;
        }

        .bubble-char {
            align-self: flex-start;
            background: #33333a;
            color: #fff;
            border-bottom-left-radius: 2px;
            border-left: 4px solid #888;
        }
        .char-name { font-size: 12px; font-weight: bold; display: block; margin-bottom: 4px; color: #888; }

        .char-spark { border-left-color: #ff3333 !important; }
        .char-spark .char-name { color: #ff3333 !important; }

        .char-cookie { border-left-color: #33aaff !important; }
        .char-cookie .char-name { color: #33aaff !important; }

        .char-rudolph { border-left-color: #8B4513 !important; }
        .char-rudolph .char-name { color: #8B4513 !important; }

        .char-barnaby { border-left-color: #28a745 !important; }
        .char-barnaby .char-name { color: #28a745 !important; }

        .bubble-player {
            align-self: flex-end;
            background: #4a6fa5;
            color: #fff;
            border-bottom-right-radius: 2px;
        }
        
        .bubble-santa {
            background: #800;
            color: #fff;
            border: 2px solid #d40;
            align-self: center;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }

        .bubble-drama {
            background: #111;
            color: #ff3333;
            border: 1px solid #ff3333;
            align-self: center;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.3);
        }

        .bubble-mystery {
            align-self: center;
            background: #e0e0e0;
            color: #111;
            border: 2px solid #fff;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #interaction-bar {
            padding: 20px;
            background: #18181d;
            border-top: 1px solid #333;
            min-height: 160px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .choice-btn {
            background: linear-gradient(135deg, #2d2d35 0%, #25252b 100%);
            color: #e0e0e0;
            border: 1px solid #444;
            padding: 12px 15px;
            text-align: left;
            cursor: pointer;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        @media (hover: hover) {
            .choice-btn:hover {
                background: #383840;
                border-color: #d4af37;
                color: #d4af37;
                transform: translateX(5px);
            }
        }

        .choice-btn:active {
            background: #444;
            border-color: #d4af37;
            color: #d4af37;
            transform: scale(0.98);
        }
        
        .replay-btn {
            background: linear-gradient(135deg, #115511 0%, #004400 100%);
            border-color: #4ecdc4;
            justify-content: center;
            font-weight: bold;
        }

        .hotspot {
            position: absolute;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 215, 0, 0.5);
            color: #ffd700;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: transform 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .hotspot:hover {
            transform: scale(1.1);
            background: #ffd700;
            color: #000;
        }
        
        .profile-content { text-align: left; line-height: 1.8; }
        .hidden { display: none !important; }
        
        /* æ‰‹æ©Ÿç‰ˆé©é… (RWD) */
        @media (max-width: 768px) {
            * { box-sizing: border-box; }
            body { overflow: hidden; overflow-x: hidden; background-image: none; background-color: #050510; align-items: flex-start; width: 100%; }
            #game-container { width: 100% !important; height: 100vh !important; height: 100dvh !important; border: none; border-radius: 0; box-shadow: none; flex-direction: column; overflow-x: hidden; }
            #visual-panel { flex: 0 0 38vh; width: 100%; border-right: none; border-bottom: 2px solid #333; z-index: 10; position: relative; }
            #narrative-panel { flex: 1; width: 100%; display: flex; flex-direction: column; min-height: 0; overflow-x: hidden; }
            #header-bar { padding: 10px 15px; min-height: 40px; flex-shrink: 0; width: 100%; }
            #feedback-area { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 15px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; width: 100%; }
            #interaction-bar { flex-shrink: 0; padding: 15px; z-index: 10; background: #18181d; width: 100%; }
            #scene-title { font-size: 16px; }
            .bubble { font-size: 15px; padding: 10px 14px; max-width: 100%; }
            .choice-btn { padding: 14px; font-size: 16px; width: 100%; }
            .hotspot { padding: 10px 15px; font-size: 14px; transform: translate(-50%, -50%); }
            
            #music-toggle { top: 10px; right: 10px; }
        }
    </style>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-71Z637FFS8"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-71Z637FFS8');
    </script>
</head>
<body>

<div id="game-container">
    <div id="audio-manager" style="display:none;">
        <audio id="bgm-main" loop>
            <source src="bgm_main.mp3" type="audio/mpeg">
        </audio>
        <audio id="bgm-tension" loop>
            <source src="bgm_tension.mp3" type="audio/mpeg">
        </audio>
        <audio id="bgm-emotional" loop>
            <source src="bgm_emotional.mp3" type="audio/mpeg">
        </audio>
        <audio id="bgm-santa" loop>
            <source src="bgm_santa.mp3" type="audio/mpeg">
        </audio>
    </div>

    <button id="music-toggle" onclick="toggleMusic()" title="é–‹é—œéŸ³æ¨‚">ğŸ”Š</button>

    <div id="visual-panel">
        <div class="overlay-gradient"></div>
    </div>

    <div id="narrative-panel">
        <div id="header-bar">
            <h2 id="scene-title">ç³»çµ±å•Ÿå‹•ä¸­...</h2>
            <div id="status-display">ğŸ’ ç‹€æ…‹: <span id="game-status" style="color:#4ecdc4">æœæŸ¥ä¸­</span></div>
        </div>

        <div id="feedback-area"></div>
        <div id="interaction-bar"></div>
    </div>
</div>

<script>
    // --- ä¿®æ”¹é» 3ï¼šé€²éšéŸ³æ¨‚æ§åˆ¶ç³»çµ± (BGM Manager) ---
    
    const BGM_VOL_MAX = 0.4; // æœ€å¤§éŸ³é‡
    let isMusicAllowed = true; // é è¨­ç‚ºé–‹ï¼Œç­‰å¾…ç¬¬ä¸€å€‹äº’å‹•
    let currentTrackId = null; 
    let fadeInterval = null; 

    function fadeIn(audioElement) {
        if (!audioElement) return;
        audioElement.volume = 0;
        audioElement.play().catch(e => console.log("ç­‰å¾…äº’å‹•æ’­æ”¾"));
        
        let vol = 0;
        const interval = setInterval(() => {
            if (vol < BGM_VOL_MAX) {
                vol += 0.02; 
                audioElement.volume = Math.min(vol, BGM_VOL_MAX);
            } else {
                clearInterval(interval);
            }
        }, 100); 
    }

    function fadeOutAndStop(audioElement) {
        if (!audioElement) return;
        let vol = audioElement.volume;
        const interval = setInterval(() => {
            if (vol > 0) {
                vol -= 0.05; 
                audioElement.volume = Math.max(vol, 0);
            } else {
                clearInterval(interval);
                audioElement.pause();
                audioElement.currentTime = 0; 
            }
        }, 100);
    }

    function switchTrack(newTrackId) {
        if (currentTrackId === newTrackId) return; 

        if (currentTrackId) {
            const oldAudio = document.getElementById(currentTrackId);
            fadeOutAndStop(oldAudio);
        }

        if (isMusicAllowed && newTrackId) {
            const newAudio = document.getElementById(newTrackId);
            fadeIn(newAudio);
        }
        
        currentTrackId = newTrackId;
    }

    // æ‰‹å‹•é–‹é—œæŒ‰éˆ•é‚è¼¯ (å·²åŠ å…¥æ•¸æ“šè¿½è¹¤)
    function toggleMusic() {
        const btn = document.getElementById('music-toggle');
        
        if (isMusicAllowed) {
            // =========== æƒ…æ³ Aï¼šç¾åœ¨æ˜¯é–‹å•Ÿï¼Œç©å®¶æƒ³è¦ã€Œé—œé–‰ã€ ===========
            
            // 1. åŸæœ¬çš„åŠŸèƒ½ï¼šè®Šæ›´ç‹€æ…‹èˆ‡åœ–ç¤º
            isMusicAllowed = false;
            btn.innerText = "ğŸ”‡"; 
            btn.style.opacity = "0.5";
            
            // 2. åŸæœ¬çš„åŠŸèƒ½ï¼šæš«åœéŸ³æ¨‚
            if (currentTrackId) {
                const audio = document.getElementById(currentTrackId);
                audio.pause();
            }

            // â˜…â˜…â˜… æ–°å¢ï¼šè¨˜éŒ„æ•¸æ“šã€Œç©å®¶é—œé–‰äº†éŸ³æ¨‚ã€ â˜…â˜…â˜…
            // é€™æ¨£ä½ å°±èƒ½åˆ†æï¼šæ˜¯ä¸æ˜¯æŸå€‹å ´æ™¯å¤ªåµï¼Ÿé‚„æ˜¯å­¸ç”Ÿä¸å–œæ­¡èƒŒæ™¯éŸ³æ¨‚ï¼Ÿ
            trackGameEvent('ui_interaction', {
                element: 'music_toggle', // äº’å‹•å…ƒä»¶ï¼šéŸ³æ¨‚é–‹é—œ
                action: 'mute',          // å‹•ä½œï¼šéœéŸ³
                scene: gameState.currentScene // è¨˜éŒ„ç™¼ç”Ÿåœ¨ä»€éº¼å ´æ™¯
            });

        } else {
            // =========== æƒ…æ³ Bï¼šç¾åœ¨æ˜¯éœéŸ³ï¼Œç©å®¶æƒ³è¦ã€Œé–‹å•Ÿã€ ===========

            // 1. åŸæœ¬çš„åŠŸèƒ½ï¼šè®Šæ›´ç‹€æ…‹èˆ‡åœ–ç¤º
            isMusicAllowed = true;
            btn.innerText = "ğŸ”Š";
            btn.style.opacity = "1";

            // 2. åŸæœ¬çš„åŠŸèƒ½ï¼šæ’­æ”¾éŸ³æ¨‚
            if (currentTrackId) {
                const audio = document.getElementById(currentTrackId);
                fadeIn(audio);
            } else {
                switchTrack('bgm-main');
            }

            // â˜…â˜…â˜… æ–°å¢ï¼šè¨˜éŒ„æ•¸æ“šã€Œç©å®¶é–‹å•Ÿäº†éŸ³æ¨‚ã€ â˜…â˜…â˜…
            trackGameEvent('ui_interaction', {
                element: 'music_toggle',
                action: 'unmute',        // å‹•ä½œï¼šå–æ¶ˆéœéŸ³
                scene: gameState.currentScene
            });
        }
    }

    function tryInitMusic() {
        if (isMusicAllowed && currentTrackId) {
            const audio = document.getElementById(currentTrackId);
            // åªæœ‰ç•¶éŸ³æ¨‚æš«åœæ™‚æ‰æ’­æ”¾ï¼Œé¿å…é‡è¤‡è§¸ç™¼
            if (audio.paused) {
                fadeIn(audio);
            }
        }
    }

    // --- 1. åˆå§‹åŒ– ---
    let audioCtx = null;
    function playSound(type) {
        if (!audioCtx) { try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){} }
        if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
    }
    
    function trackGameEvent(eventName, params = {}) {
        if (typeof gtag === 'function') {
            gtag('event', eventName, params);
        }
    }

    // --- 2. éŠæˆ²è³‡æ–™ ---
    const STORAGE_KEY = 'christmasMysteryGameSave';
    let gameState = {
        visited: new Set(),
        usedActions: new Set(),
        currentScene: '',
        sceneLogs: {}, 
        wrongAccusationCount: 0,
        lastAccused: null,
        startTime: Date.now(), 
        actionTotal: 0,
        hasKey: false
    };

    function saveGameState() {
        const stateToSave = {
            ...gameState,
            visited: Array.from(gameState.visited),
            usedActions: Array.from(gameState.usedActions),
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
    }

    function loadGameState() {
        const savedState = localStorage.getItem(STORAGE_KEY);
        if (savedState) {
            const parsedState = JSON.parse(savedState);
            gameState = {
                ...parsedState,
                visited: new Set(parsedState.visited),
                usedActions: new Set(parsedState.usedActions),
            };
            if (gameState.currentScene && gameState.sceneLogs[gameState.currentScene]) {
                return true;
            }
        }
        return false;
    }

    const contentData = {
        profiles: {
            spark: `
                <div class="profile-content" style="border-left:4px solid #ff3333; padding-left:10px;">
                <b>ã€å²æ´¾å…‹ Sparkã€‘</b><br>
                ğŸ”§ <b>è·æ¥­ï¼š</b> ç²¾éˆç™¼æ˜å®¶<br>
                ğŸ“ <b>èº«é«˜ï¼š</b> 35 é¡†èºçµ²å¸½é«˜<br>
                ğŸ“‹ <b>ç‹€æ…‹ï¼š</b> æ»¿èº«æ©Ÿæ²¹ï¼Œæ­£åœ¨æ•²æ‰“æ©Ÿæ¢°ã€‚<br>
                <hr style="border-color:#444;">
                <b>ã€å¥åº·ç´€éŒ„ã€‘</b> æ‰‹éƒ¨ç¥ç¶“é¡«æŠ–ï¼ˆé•·æœŸæ‹¿é‡ç‰©ï¼‰ã€‚<span style="color:#ff3333">é†«ç”Ÿå»ºè­°ï¼šç¦æ­¢ç²¾ç´°ä½œæ¥­ã€‚</span><br>
                <b>ã€å‹¤å‹™ç´€éŒ„ã€‘</b> ç”³è«‹ã€Œå¤œé–“åŠ ç­ã€ç ”ç™¼é›»æ± ã€‚å¤šæ¬¡æŠ±æ€¨èƒ½æºä¸è¶³ã€‚
                </div>`,
            cookie: `
                <div class="profile-content" style="border-left:4px solid #33aaff; padding-left:10px;">
                <b>ã€åº«å¥‡ Cookieã€‘</b><br>
                ğŸª <b>è·æ¥­ï¼š</b> çš‡å®¶å¤§å»š<br>
                ğŸ“ <b>èº«é«˜ï¼š</b> 20 å±¤è–‘é¤…äººé«˜<br>
                ğŸ“‹ <b>ç‹€æ…‹ï¼š</b> åœ¨å»šæˆ¿ç„¦æ…®åœ°è¸±æ­¥ã€‚<br>
                <hr style="border-color:#444;">
                <b>ã€å¥åº·ç´€éŒ„ã€‘</b> é«”é‡èˆ‡é«”è„‚éé«˜ï¼Œè†è“‹è² é‡éå¤§ã€‚<span style="color:#33aaff">é†«ç”Ÿå»ºè­°ï¼šé¿å…çˆ¬æ¨“æ¢¯èˆ‡é«˜è™•ä½œæ¥­ã€‚</span><br>
                <b>ã€å‹¤å‹™ç´€éŒ„ã€‘</b> ç”³è«‹ã€Œåƒè§€é˜æ¨“ã€è¢«æ‹’çµ•ã€‚ç›®æ“Šç´€éŒ„ï¼šåœ¨å¡”ä¸‹å¾˜å¾Šæ¸¬é‡å°ºå¯¸ã€‚
                </div>`,
            rudolph: `
                <div class="profile-content" style="border-left:4px solid #8B4513; padding-left:10px;">
                <b>ã€é­¯é“å¤« Rudolphã€‘</b><br>
                ğŸ¦Œ <b>è·æ¥­ï¼š</b> é ˜èˆªé¦´é¹¿<br>
                ğŸ“ <b>èº«é«˜ï¼š</b> 1.5 æ£µè–èª•æ¨¹é«˜<br>
                ğŸ“‹ <b>ç‹€æ…‹ï¼š</b> èººåœ¨ç¨»è‰å †ä¸­ï¼Œè“‹è‘—åšæ¯¯å­ã€‚<br>
                <hr style="border-color:#444;">
                <b>ã€å¥åº·ç´€éŒ„ã€‘</b> é«”æº«æŒçºŒéé«˜ (Overheating)ï¼Œé¼»é ­ç´…è…«ã€‚<br>
                <b>ã€å‹¤å‹™ç´€éŒ„ã€‘</b> é€£çºŒä¸‰æ¬¡ã€Œé£›è¡Œè¨“ç·´ã€ç¼ºå¸­ã€‚<span style="color:#8B4513">å‚™è¨»ï¼šè«‹å‡ç†ç”±æ˜¯ã€Œä¸æƒ³é£›ã€ã€‚</span>
                </div>`
        },
        descriptions: {
            lab: "å¯¦é©—å®¤é›œäº‚ç„¡ç« ã€‚ä¸­å¤®æ”¾è‘—ä¸€å°å·¨å¤§çš„ç«ç®­å¼•æ“ï¼Œå‘¨åœæ•£è½è‘—ç„¡æ•¸èºçµ²å’Œé½’è¼ªã€‚",
            kitchen: "å»šæˆ¿æ¡Œä¸Šæ”¾è‘—ä¸€ç›¤å‰›è£é£¾å¥½çš„ç”œç”œåœˆï¼Œç©ºæ°£ä¸­å……æ»¿äº†ç”œè†©çš„é¦™æ°£ã€‚åº«å¥‡çœ‹èµ·ä¾†éå¸¸ç·Šå¼µã€‚",
            barn: "é¦¬å»„å¾ˆå®‰éœã€‚é­¯é“å¤«èººåœ¨ç¨»è‰å †è£¡ç¡è¦ºï¼Œå¶çˆ¾å‚³ä¾†å‘¼åš•è²ã€‚",
            tower_top: "ï¼ˆèª¿æŸ¥åœ°é»ï¼‰é˜æ¨“å¡”é ‚å¯’é¢¨å‡œå†½ã€‚åŸæœ¬æ”¾ç½®ã€Œæ°¸æ†é½’è¼ªã€çš„åŸºåº§ç¾åœ¨ç©ºç©ºå¦‚ä¹Ÿã€‚å››å‘¨é™¤äº†é›ªï¼Œæ²’æœ‰å…¶ä»–æ±è¥¿ã€‚",
            cabin: "å°æœ¨å±‹å±‹å…§éå¸¸æº«æš–ã€‚è¾¦å…¬å®¤å…§çš„ä½ˆç½®éå¸¸æº«é¦¨ã€‚èº«ç‚ºå®Œç¾çš„åŠ©æ‰‹ï¼Œå·´ç´æ¯”å·²ç¶“æŠŠç›¸é—œè³‡æ–™éƒ½æ•´ç†é€²å«Œç–‘äººæª”æ¡ˆè£¡äº†ã€‚"
        },
        clues: {
            spark: {
                engine: "ã€èª¿æŸ¥çµæœã€‘ç«ç®­å¼•æ“è™•æ–¼åŠæˆå“ç‹€æ…‹ã€‚ç«ç®­çš„æ ¸å¿ƒå‹•åŠ›å€è¢«ç•«äº†ç´…åœˆï¼Œæ—é‚Šçš„è¨­è¨ˆåœ–å¯«è‘—ï¼šã€Œç¾æœ‰é›»æ± å‹•åŠ›ä¸è¶³ï¼Œæ€¥éœ€ã€æ°¸æ†ã€ç´šåˆ¥çš„èƒ½æºæ›¿ä»£...ã€",
                grappling_hook: "ã€èª¿æŸ¥çµæœã€‘ä¸€æŠŠæ”¹é€ éçš„ã€Œå¼·åŠ›ç£éµå›æ”¶çˆªã€ï¼Œé€™æ˜¯å¯ä»¥é ç«¯å¸å–é‡‘å±¬çš„è£ç½®ã€‚çˆªå­ä¸Šæ²¾æ»¿äº†åšåšä¸€å±¤ã€é‚„åœ¨æ»´è½çš„é»‘è‰²æ©Ÿæ²¹ã€‚"
            },
            cookie: {
                cookie_powder: "ã€èª¿æŸ¥çµæœã€‘æ¡Œä¸Šæœ‰ä¸€ç›¤ç‘æ»¿ç³–ç²‰çš„ç”œç”œåœˆã€‚ç³–ç²‰å‘ˆç¾ç‰¹æ®Šçš„è¢å…‰è—è‰²ã€‚é€™ç¨®ç²‰æœ«é¡†ç²’æ¥µç´°ï¼Œå¸¶æœ‰éœé›»ï¼Œæ¥µæ˜“å¸é™„åœ¨è¡£ç‰©æˆ–çš®è†šè¡¨é¢ã€‚",
                blueprint_sketch: "ã€èª¿æŸ¥çµæœã€‘ä¸€å¼µç•«åœ¨æ²¹æ¼¬é¤å·¾ç´™ä¸Šçš„è‰åœ–ã€‚æ¨™è¨»è‘—ï¼šã€Œå¿…é ˆåœ¨åˆå¤œå‰å®Œæˆæ›¿æ›ã€ã€ã€Œçµæ§‹è¦è¶³ä»¥ä»¥å‡äº‚çœŸã€ã€‚"
            },
            tower: {
                window_trace: "ã€èª¿æŸ¥çµæœã€‘20 å…¬å°ºé«˜çš„é€šé¢¨çª—å¤–ï¼Œçª—å°ç©è‘—åšåšçš„é›ªã€‚ä½ ä»”ç´°æª¢æŸ¥äº†é›ªé¢ï¼šå‘ˆç¾å®Œç¾çš„è‡ªç„¶å †ç©æ›²ç·šï¼Œæ²’æœ‰ä»»ä½•è…³å°ã€æ²’æœ‰æ¢¯å­é ‚ç«¯çš„å£“ç—•ï¼Œä¹Ÿæ²’æœ‰ç¹©ç´¢æ‹–æ›³çš„è»Œè·¡ã€‚",
                blue_powder_scene: "ã€èª¿æŸ¥çµæœã€‘åŸæœ¬æ”¾ç½®é½’è¼ªçš„åŸºåº§ç©ºç©ºå¦‚ä¹Ÿã€‚åŸºåº§è¡¨é¢éå¸¸ä¹¾æ·¨ï¼Œå®Œå…¨æ²’æœ‰æ²¹æ¼¬ï¼Œä½†æœ‰æ¡é›†åˆ°äº†è¢å…‰è—è‰²ç²‰æœ«ã€‚" 
            },
            rudolph: {
                donut_box: "ã€èª¿æŸ¥çµæœã€‘è§’è½çš„ç”œç”œåœˆç›’å­æ˜¯ç©ºçš„ã€‚é›–ç„¶é­¯é“å¤«é–‰è‘—çœ¼ï¼Œä½†åœ¨ä»–é¹¿è§’èˆ‡é¼»å°–ä¸Šï¼Œæ²¾è‘—äº›è¨±é¡¯çœ¼çš„è—è‰²ç²‰æœ«ã€‚",
                blanket_hidden: "ã€èª¿æŸ¥çµæœã€‘ä½ å°‡æ‰‹ä¼¸é€²æ¯¯å­ä¸‹æ–¹ã€‚é­¯é“å¤«çš„çš®æ¯›æ‘¸èµ·ä¾†æ¿•æ½¤ä¸”æº«åº¦å¾ˆé«˜ã€‚ç•¶ä»–åæ°£æ™‚ï¼Œé¼»å­”å™´å‡ºäº†æ˜é¡¯çš„ç™½éœ§ã€‚" 
            }
        }
    };
    const scenes = {
        start_screen: {
            title: "è–èª•å¤œçš„æ¶ˆå¤±é½’è¼ª",
            image: "title_bg.jpg", 
            initText: "", 
            choices: [{ text: "ğŸšª æ¨é–‹å¤§é–€", action: "start_game" }]
        },
        game_fin: {
            title: "THE END",
            image: "fin_bg.jpg", 
            initText: "æ„Ÿè¬æ‚¨çš„éŠç©ï¼<br><br>è–èª•æ‘çš„æ™‚é–“å†æ¬¡æµå‹•ï¼Œ<br>é€™ä¸€åˆ‡éƒ½æ­¸åŠŸæ–¼æ‚¨ã€‚<br><br>ç‚ºäº†å¹«åŠ©æˆ‘å€‘åšå‡ºæ›´å¥½çš„éŠæˆ²ï¼Œ<br>æ‡‡è«‹å¤§åµæ¢èŠ± 1 åˆ†é˜å¡«å¯«å›é¥‹ï¼",
            choices: [
                { text: "ğŸ“‹ å¡«å¯«åµæ¢å›é¥‹å–®", action: "open_survey" },
                { text: "ğŸ”„ å†ç©ä¸€æ¬¡", action: "reload" }
            ]
        },
        opening_frozen: {
            title: "11:59 çš„è–èª•æ‘",
            image: "invitation.jpg", 
            initText: "",
            choices: [{ text: "ç­‰å¾…ç´„å®šæ™‚é–“", action: "play_prologue" }]
        },
        prologue: {
            title: "è–èª•è€äººçš„é æ„Ÿ",
            image: "barnaby_enter.jpg", 
            initText: "", 
            choices: [{ text: "æ¥éäººå“¡åå–®", action: "goto:files" }]
        },
        files: {
            title: "å«Œç–‘äººæª”æ¡ˆ",
            image: "files.jpg",
            initText: "é€™æ˜¯ç›®å‰å…¨è–èª•æ‘å”¯ä¸‰æ²’æœ‰è¢«ã€Œæ™‚é–“å‡çµã€çš„äººã€‚æ ¹æ“šå·´ç´æ¯”çš„åˆ¤æ–·ï¼ŒçŠ¯äººä¸€å®šå°±åœ¨å…¶ä¸­ã€‚",
            hotspots: [
                { label: "ğŸ“ æª”æ¡ˆï¼šå²æ´¾å…‹", top: "20%", left: "55%", action: "read:spark" },
                { label: "ğŸ“ æª”æ¡ˆï¼šåº«å¥‡", top: "60%", left: "20%", action: "read:cookie" },
                { label: "ğŸ“ æª”æ¡ˆï¼šé­¯é“å¤«", top: "60%", left: "70%", action: "read:rudolph" }
            ],
            choices: [{ text: "å‰å¾€ç¾å ´æœæŸ¥", action: "goto:hub" }]
        },
        hub: {
            title: "ä¸­å¤®å»£å ´",
            image: "hub.jpg",
            initText: "ã€æœæŸ¥ä»»å‹™å•Ÿå‹•ã€‘<br>ç›®å‰æ™‚é–“åœæ­¢åœ¨ 11:59ã€‚ä½ å¿…é ˆå®Œæˆä»¥ä¸‹ç›®æ¨™ï¼š<br><br>1. æ‰¾å‡ºç«Šå–ã€Œæ°¸æ†é½’è¼ªã€çš„çŠ¯äººã€‚<br>2. æŒæ¡çŠ¯æ¡ˆæ‰‹æ®µä»¥åŠèƒ½å¤ å®šç½ªçš„é—œéµç‰©ç†è­‰æ“šã€‚",
            hotspots: [
                { label: "ğŸš€ å¯¦é©—å®¤", top: "40%", left: "15%", action: "goto:lab" },
                { label: "ğŸª é»å¿ƒæˆ¿", top: "40%", left: "75%", action: "goto:kitchen" },
                { label: "ğŸ¦Œ é¦¬å»„", top: "70%", left: "50%", action: "goto:barn" },
                { label: "ğŸ° é˜æ¨“å¡”é ‚", top: "15%", left: "45%", action: "check_lock:tower_top" }, 
                { label: "ğŸ  å°æœ¨å±‹", top: "85%", left: "15%", action: "goto:cabin" }
            ],
            choices: [
                { text: "ğŸ“‚ é‡çœ‹å«Œç–‘äººæª”æ¡ˆ", action: "goto:files" },
                { text: "âš–ï¸ æˆ‘å·²ç¶“çŸ¥é“çŠ¯äººæ˜¯èª°äº†ï¼", action: "pre_accuse" } 
            ]
        },
        cabin: {
            title: "å°æœ¨å±‹",
            image: "cabin.jpg", 
            initText: contentData.descriptions.cabin,
            hotspots: [], 
            choices: [
                { text: "ğŸ—£ï¸ èˆ‡å·´ç´æ¯”å°è©±", action: "goto:chat_barnaby" },
                { text: "ğŸ‘£ è¿”å›å»£å ´", action: "goto:hub" }
            ]
        },
        chat_barnaby: {
            title: "å°è©±ï¼šå·´ç´æ¯”",
            image: "face_barnaby.jpg", 
            character: "å·´ç´æ¯”",
            initText: "ã€Œåµæ¢ï¼Œæœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«å¿™çš„å—ï¼Ÿã€",
            choices: [
                { text: "ğŸ”‘ å€Ÿç”¨é˜æ¨“é‘°åŒ™", action: "chat:barnaby_key" },
                { text: "ğŸ—£ï¸ è©¢å•é—œæ–¼å²æ´¾å…‹", action: "chat:barnaby_spark" },
                { text: "ğŸ—£ï¸ è©¢å•é—œæ–¼åº«å¥‡", action: "chat:barnaby_cookie" },
                { text: "ğŸ—£ï¸ è©¢å•é—œæ–¼é­¯é“å¤«", action: "chat:barnaby_rudolph" },
                { text: "ğŸ’¬ çµæŸå°è©±", action: "goto:cabin" }
            ]
        },
        tower_top: {
            title: "é˜æ¨“å¡”é ‚",
            image: "tower_top.jpg",
            initText: contentData.descriptions.tower_top,
            hotspots: [
                { label: "ğŸªŸ æª¢æŸ¥çª—æˆ¶", top: "30%", left: "50%", action: "check:window_trace" },
                { label: "âœ¨ æª¢æŸ¥åŸºåº§", top: "60%", left: "50%", action: "check:blue_powder_scene" }
            ],
            choices: [{ text: "è¿”å›å»£å ´", action: "goto:hub" }]
        },
        lab: {
            title: "å²æ´¾å…‹çš„å¯¦é©—å®¤",
            image: "lab.jpg",
            initText: contentData.descriptions.lab,
            hotspots: [
                { label: "âš™ï¸ æª¢æŸ¥å¼•æ“ç‹€æ³", top: "50%", left: "50%", action: "check:engine" },
                { label: "âœ‹ æª¢æŸ¥å¥‡æ€ªçš„å·¥å…·", top: "70%", left: "30%", action: "check:grappling_hook" }
            ],
            choices: [
                { text: "ğŸ—£ï¸ è³ªå•å²æ´¾å…‹", action: "goto:chat_spark" },
                { text: "ğŸ‘£ è¿”å›å»£å ´", action: "goto:hub" }
            ]
        },
        kitchen: {
            title: "åº«å¥‡çš„é»å¿ƒæˆ¿",
            image: "kitchen.jpg",
            initText: contentData.descriptions.kitchen,
            hotspots: [
                { label: "ğŸ© æª¢æŸ¥ç³–ç²‰", top: "60%", left: "50%", action: "check:cookie_powder" },
                { label: "ğŸ“ å¥‡æ€ªçš„è‰åœ–", top: "75%", left: "20%", action: "check:blueprint_sketch" }
            ],
            choices: [
                { text: "ğŸ—£ï¸ è³ªå•åº«å¥‡", action: "goto:chat_cookie" },
                { text: "ğŸ‘£ è¿”å›å»£å ´", action: "goto:hub" }
            ]
        },
        barn: {
            title: "é¦´é¹¿é¦¬å»„",
            image: "barn.jpg",
            initText: contentData.descriptions.barn,
            hotspots: [
                { label: "ğŸ‘„ è§€å¯Ÿé­¯é“å¤«", top: "50%", left: "60%", action: "check:donut_box" },
                { label: "ğŸ›Œ æª¢æŸ¥æ¯¯å­", top: "75%", left: "40%", action: "check:blanket_hidden" } 
            ],
            choices: [
                { text: "ğŸ—£ï¸ è³ªå•é­¯é“å¤«", action: "goto:chat_rudolph" },
                { text: "ğŸ‘£ è¿”å›å»£å ´", action: "goto:hub" }
            ]
        },
        chat_spark: {
            title: "å°è©±ï¼šå²æ´¾å…‹",
            image: "face_spark.jpg",
            character: "å²æ´¾å…‹",
            choices: [
                { text: "ğŸ•’ ä½ ä»Šæ™šéƒ½åœ¨åšä»€éº¼ï¼Ÿ", action: "chat:spark_alibi" },
                { text: "ğŸ‘€ ä½ æœ‰æ³¨æ„åˆ°ä»€éº¼ç•°å¸¸å—ï¼Ÿ", action: "chat:spark_suspect" },
                { text: "ğŸ” é—œæ–¼é‚£å€‹å›æ”¶çˆª...", action: "chat:spark_tool" },
                { text: "ğŸ’¬ çµæŸå°è©±", action: "goto:lab" }
            ]
        },
        chat_cookie: {
            title: "å°è©±ï¼šåº«å¥‡",
            image: "face_cookie.jpg",
            character: "åº«å¥‡",
            choices: [
                { text: "ğŸ•’ ä½ ä»Šæ™šéƒ½åœ¨åšä»€éº¼ï¼Ÿ", action: "chat:cookie_alibi" },
                { text: "ğŸ‘€ ä½ æœ‰æ³¨æ„åˆ°ä»€éº¼ç•°å¸¸å—ï¼Ÿ", action: "chat:cookie_suspect" },
                { text: "ğŸ” é—œæ–¼é‚£å¼µè‰åœ–...", action: "chat:cookie_sketch" },
                { text: "ğŸ’¬ çµæŸå°è©±", action: "goto:kitchen" }
            ]
        },
        chat_rudolph: {
            title: "å°è©±ï¼šé­¯é“å¤«",
            image: "face_rudolph.jpg",
            character: "é­¯é“å¤«",
            choices: [
                { text: "ğŸ•’ ä½ ä»Šæ™šéƒ½åœ¨åšä»€éº¼ï¼Ÿ", action: "chat:rudolph_alibi" },
                { text: "ğŸ‘€ ä½ æœ‰æ³¨æ„åˆ°ä»€éº¼ç•°å¸¸å—ï¼Ÿ", action: "chat:rudolph_suspect" },
                { text: "ğŸ” é—œæ–¼ä½ èº«ä¸Šçš„ç²‰æœ«...", action: "chat:rudolph_powder" },
                { text: "ğŸ’¬ çµæŸå°è©±", action: "goto:barn" }
            ]
        },
        accuse_drama: {
            title: "æŒ‡èªæ™‚åˆ»",
            image: "accuse_drama.jpg",
            initText: "", 
            choices: [] 
        },
        accuse_denial: {
            title: "æŒ‡èªéŒ¯èª¤",
            image: "spark_denial_1.jpg", 
            initText: "",
            choices: []
        },
        ending_confession: {
            title: "æ²‰é‡çš„çœŸç›¸",
            image: "rudolph_cry.jpg",
            initText: "", 
            choices: []
        },
        ending_teamwork: {
            title: "æˆ‘å€‘æ˜¯åœ˜éšŠ",
            image: "teamwork.jpg",
            initText: "", 
            choices: []
        },
        ending_gear_fix: {
            title: "é½’è¼ªæ­¸ä½",
            image: "fix_gear.jpg",
            initText: "",
            choices: []
        },
        ending_santa_reveal: {
            title: "ç†Ÿæ‚‰çš„ç¬‘è²",
            image: "santa_voice.jpg", 
            initText: "", 
            choices: [] 
        },
        ending_real_face: {
            title: "è–èª•å¿«æ¨‚",
            image: "santa_claus.jpg", 
            initText: "",
            choices: []
        }
    };

    // --- 3. æ ¸å¿ƒé‚è¼¯ ---

    let dialogueQueue = [];
    let isDialogueRunning = false;
    let dialogueOnComplete = null;
    let dialogueTimer = null; 
    const clickArea = document.getElementById('game-container');
    
    function renderScene(id, isResuming = false) {
        if (!scenes[id]) return;
        const scene = scenes[id];
        const isUpdate = (gameState.currentScene === id);
        
        // --- ä¿®æ”¹é» 5ï¼šéŸ³æ¨‚å ´æ™¯åˆ‡æ› ---
        if (id === 'start_screen' || id === 'hub' || id === 'lab' || id === 'kitchen' || id === 'barn') {
            switchTrack('bgm-main');
        } else if (id === 'accuse_drama') {
            switchTrack('bgm-tension');
        } else if (id === 'ending_confession' || id === 'ending_teamwork') {
            switchTrack('bgm-emotional');
        } else if (id === 'ending_santa_reveal' || id === 'ending_real_face') {
            switchTrack('bgm-santa');
        }

        if (id === 'hub' && gameState.hasKey && gameState.sceneLogs['hub']) {
            let log = gameState.sceneLogs['hub'];
            log = log.replace(/<div class="bubble bubble-system"[^>]*>.*?çœ‹ä¾†æ²’æœ‰é‘°åŒ™æ˜¯é€²ä¸å»çš„.*?<\/div>/g, '');
            log = log.replace(/<div class="bubble bubble-system"[^>]*>.*?ï¼ˆæ‹‰äº†æ‹‰é–€æŠŠï¼‰.*?<\/div>/g, '');
            gameState.sceneLogs['hub'] = log;
        }

        if (!isUpdate || isResuming) {
            gameState.currentScene = id;
            trackGameEvent('scene_view', {
                scene_id: id,
                scene_title: scene.title
            });
            const vis = document.getElementById('visual-panel');
            const header = document.getElementById('scene-title');
            const feedback = document.getElementById('feedback-area');

            const statusContainer = document.getElementById('status-display');
            let statusText = "æœæŸ¥ä¸­";
            let statusIcon = "ğŸ’";
            if (id === 'start_screen') {
                statusText = "æº–å‚™ä¸­";
                statusIcon = "ğŸ¬";
            } else if (id === 'game_fin') {
                statusText = "å®Œçµ";
                statusIcon = "ğŸ";
            } else if (['opening_frozen', 'prologue'].includes(id)) {
                statusText = "ç·Šæ€¥äº‹æ…‹";
                statusIcon = "ğŸš¨";
            } else if (id.startsWith('ending')) {
                statusText = "è–èª•å¥‡è¹Ÿ";
                statusIcon = "ğŸ„";
            } else if (id.startsWith('accuse')) {
                statusText = "æŒ‡èªå«ŒçŠ¯";
                statusIcon = "âš–ï¸";
            }
            
            statusContainer.innerHTML = `${statusIcon} ç‹€æ…‹: <span id="game-status" style="color:#4ecdc4">${statusText}</span>`;
            if (!isDialogueRunning) {
                vis.innerHTML = '<div class="overlay-gradient"></div>';
                vis.classList.add('fade-out');
                setTimeout(() => {
                    vis.style.backgroundImage = `url('${scene.image}')`;
                    vis.classList.remove('fade-out'); 
                }, 200);
            }

            header.innerText = scene.title;
            if (gameState.sceneLogs[id]) {
                feedback.innerHTML = gameState.sceneLogs[id];
            } else {
                feedback.innerHTML = '';
                if (scene.initText && !isResuming) {
                    addBubble(scene.initText, 'system');
                }
            }

            if (scene.hotspots && !isDialogueRunning && !id.startsWith('ending') && !id.startsWith('accuse')) {
                scene.hotspots.forEach(spot => {
                    const btn = document.createElement('div');
                    btn.className = 'hotspot';
                    btn.style.top = spot.top;
                    btn.style.left = spot.left;
                    btn.innerHTML = spot.label;
                    btn.onclick = () => handleAction(spot.action, spot.label);
                    vis.appendChild(btn);
                });
            }
        }

        renderButtons(scene);
        if (['lab', 'kitchen', 'barn', 'tower_top'].includes(id)) gameState.visited.add(id);
        
        if (id === 'opening_frozen' && !gameState.visited.has('opening') && !isResuming) {
            gameState.visited.add('opening');
            runDialogueSequence([
                {t: "åœ¨ä¸€è™•æº«æš–çš„æœ¨å±‹ä¸­ï¼Œä½ ä½é ­çœ‹è‘—æ‰‹ä¸­çš„é‡‘ç®”é‚€è«‹å‡½...", type: 'system'},
                {t: "ã€è‡´ å‚³å¥‡åµæ¢ï¼šä»Šæ™šæˆ–è¨±æœƒæœ‰å¤§äº‹ç™¼ç”Ÿï¼Œè«‹å‹™å¿…ä¾†è–èª•æ‘ä¸€æ•˜ã€‚â€”â€” è–èª•è€äººã€", type: 'system'},
                {t: "ä½ ååœ¨æº«æš–çš„å£çˆå‰ï¼Œç‰†ä¸Šçš„æ›é˜æ­£æ»´ç­”ä½œéŸ¿ã€‚", type: 'system'},
                {t: "ç§’é‡æŒ‡å‘äº† 11:59 åˆ† 59 ç§’ã€‚", type: 'system'},
                {t: "åŸæœ¬è©²éŸ¿èµ·çš„æ•´é»é˜è²... å»æ²’æœ‰å‡ºç¾ã€‚", type: 'system'},
                {t: "ç«ç„°å‡å›ºåœ¨åŠç©ºä¸­ï¼Œçª—å¤–çš„é›ªèŠ±æ‡¸åœä¸å‹•ã€‚ä¸–ç•Œè¢«æŒ‰ä¸‹äº†æš«åœéµã€‚", type: 'system'}
            ]);
        }
        
        saveGameState();
    }

    function renderButtons(scene) {
        const menu = document.getElementById('interaction-bar');
        menu.innerHTML = '';
        if (scene.choices) {
            scene.choices.forEach(c => {
                if (c.action.startsWith('chat:') && gameState.usedActions.has(c.action)) return;
                if (c.action.startsWith('ending:team_') && gameState.usedActions.has(c.action)) return;

                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                
                if (c.action === 'reload' || c.action === 'ending:fix_gear' || c.action === 'start_game') {
                    btn.className += ' replay-btn';
                }
     
                btn.innerHTML = c.text.startsWith('ğŸ”¹') || c.text.startsWith('âš™ï¸') || c.text.startsWith('ğŸ•’') || c.text.startsWith('ğŸ‘€') || c.text.startsWith('ğŸ”') || c.text.startsWith('ğŸ®') || c.text.startsWith('ğŸ”„') ? c.text : "ğŸ”¹ " + c.text;
                btn.onclick = () => handleAction(c.action, c.text);
                menu.appendChild(btn);
            });
        }
    }

    function addBubble(text, type, name) {
        const feedback = document.getElementById('feedback-area');
        const div = document.createElement('div');
        
        if (type === 'system') {
            div.className = 'bubble bubble-system';
            div.innerHTML = text;
        } else if (type === 'char') {
            div.className = 'bubble bubble-char';
            if (name && name.includes('å²æ´¾å…‹')) div.classList.add('char-spark');
            else if (name && name.includes('åº«å¥‡')) div.classList.add('char-cookie');
            else if (name && name.includes('é­¯é“å¤«')) div.classList.add('char-rudolph');
            else if (name && name.includes('å·´ç´æ¯”')) div.classList.add('char-barnaby');
            div.innerHTML = `<span class="char-name">${name}</span>${text}`;
        } else if (type === 'player') {
            div.className = 'bubble bubble-player';
            div.innerHTML = text;
        } else if (type === 'santa') {
            div.className = 'bubble bubble-santa';
            div.innerHTML = text;
        } else if (type === 'drama') { 
            div.className = 'bubble bubble-drama';
            div.innerHTML = text;
        } else if (type === 'mystery') { 
            div.className = 'bubble bubble-mystery';
            div.innerHTML = text;
        }
        
        feedback.appendChild(div);
        if (!gameState.sceneLogs[gameState.currentScene]) {
            gameState.sceneLogs[gameState.currentScene] = '';
        }
        gameState.sceneLogs[gameState.currentScene] += div.outerHTML;

        requestAnimationFrame(() => { feedback.scrollTop = feedback.scrollHeight; });
        saveGameState();
    }

    function processNextDialogueLine() {
        clearTimeout(dialogueTimer);
        if (dialogueQueue.length > 0) {
            const line = dialogueQueue.shift();
            addBubble(line.t, line.type || 'system', line.name);
            
            if (dialogueQueue.length > 0) {
                dialogueTimer = setTimeout(processNextDialogueLine, 2200);
            } else {
                isDialogueRunning = false;
                clickArea.removeEventListener('click', processNextDialogueLine);
                if (dialogueOnComplete) {
                    setTimeout(dialogueOnComplete, 800);
                } else {
                    renderScene(gameState.currentScene);
                }
            }
        }
    }

    function runDialogueSequence(lines, onComplete) {
        clearTimeout(dialogueTimer);
        clickArea.removeEventListener('click', processNextDialogueLine);
        
        const menu = document.getElementById('interaction-bar');
        menu.innerHTML = ''; 
        
        dialogueQueue = [...lines];
        isDialogueRunning = true;
        dialogueOnComplete = onComplete;
        
        clickArea.addEventListener('click', processNextDialogueLine);
        processNextDialogueLine();
    }

    function playPrologueSequence() {
        renderScene('prologue');
        gameState.sceneLogs['prologue'] = '';
        document.getElementById('feedback-area').innerHTML = '';

        runDialogueSequence([
            {t: "ï¼ˆç¢°ï¼æ¥å¾…å®¤çš„å¤§é–€è¢«æ’é–‹ï¼ï¼‰", type: "system"},
            {t: "è–èª•è€äººçš„åŠ©æ‰‹â€”â€”å·´ç´æ¯”ï¼Œæ…Œå¼µåœ°è¡äº†é€²ä¾†ï¼Œå·®é»è¢«åœ°æ¯¯çµ†å€’ã€‚", type: "system"},
            {t: "è–èª•è€äººï¼å¤§äº‹ä¸å¥½äº†... å’¦ï¼Ÿä½ æ˜¯ï¼Ÿ", type: "char", name: "å·´ç´æ¯”"},
            {t: "å•Šï¼ä½ æ˜¯é‚£å°é‚€è«‹å‡½çš„... åµæ¢ï¼æ„Ÿè¬è€å¤©ä½ åœ¨é€™è£¡ï¼", type: "char", name: "å·´ç´æ¯”"}, 
            {t: "è–èª•è€äººä¸è¦‹äº†ï¼Œè€Œã€Œæ°¸æ†é½’è¼ªã€å‰›å‰›è¢«å·èµ°ï¼ç¾åœ¨æ™‚é–“å®Œå…¨åœæ­¢äº†ï¼", type: "char", name: "å·´ç´æ¯”"},
            {t: "æˆ‘å‰›æ‰è¶•å¿«ç¢ºèªäº†è–èª•æ‘çš„ç‹€æ³ï¼Œé™¤äº†æˆ‘ä¹‹å¤–ï¼Œåªæœ‰ä¸‰å€‹äººæ²’æœ‰è¢«æ™‚é–“å‡çµã€‚", type: "char", name: "å·´ç´æ¯”"},
            {t: "æˆ‘æŠŠä»–å€‘çš„è³‡æ–™éƒ½èª¿å‡ºä¾†äº†ï¼Œæ‹œè¨—ä½ ï¼Œä¸€å®šè¦æ‰¾å‡ºæ˜¯èª°åšçš„ï¼", type: "char", name: "å·´ç´æ¯”"}
        ], () => {
             const menu = document.getElementById('interaction-bar');
             const btn = document.createElement('button');
             btn.className = 'choice-btn';
             btn.innerText = "ğŸ”¹ æŸ¥çœ‹é€™ä¸‰äººçš„è³‡æ–™";
             btn.onclick = () => handleAction('goto:files');
             menu.appendChild(btn);
        });
    }

    function playAccusationSequence() {
        renderScene('accuse_drama');
        gameState.sceneLogs['accuse_drama'] = '';
        document.getElementById('feedback-area').innerHTML = '';

        runDialogueSequence([
            {t: "æ’é™¤ä¸å¯èƒ½çš„å› ç´ å¾Œï¼Œå‰©ä¸‹çš„...", type: "drama"},
            {t: "ç„¡è«–å¤šéº¼ä¸å¯æ€è­°ï¼Œé‚£å°±æ˜¯çœŸç›¸ï¼", type: "drama"},
            {t: "çŠ¯äººå°±åœ¨æˆ‘å€‘ä¹‹ä¸­ï¼", type: "drama"}
        ], () => {
             const menu = document.getElementById('interaction-bar');
             ['å²æ´¾å…‹', 'åº«å¥‡', 'é­¯é“å¤«'].forEach(name => {
                 const btn = document.createElement('button');
                 btn.className = 'choice-btn';
                 btn.style.justifyContent = 'center';
                 btn.style.fontWeight = 'bold';
                 btn.innerText = `ğŸ‘‰ æŒ‡èª ${name}`;
                 btn.onclick = () => handleAccusation(name);
                 menu.appendChild(btn);
             });
        });
    }

    function handleAccusation(name) {
        // --- æ­¥é©Ÿ 1ï¼šè¨ˆç®—ç©å®¶ç›®å‰æ‰¾åˆ°äº†å¹¾å€‹ç·šç´¢ ---
        let evidenceCount = 0;
        gameState.usedActions.forEach(action => {
            // åªè¦å‹•ä½œæ˜¯ã€ŒæŸ¥çœ‹ (check)ã€æˆ–ã€Œé–±è®€æª”æ¡ˆ (read)ã€å°±ç®—æ˜¯ä¸€å€‹è­‰æ“š
            if (action.startsWith('check:') || action.startsWith('read:')) {
                evidenceCount++;
            }
        });

        // --- æ­¥é©Ÿ 2ï¼šè‡ªå‹•è¨ˆç®—éŠæˆ²ç¸½å…±æœ‰å¤šå°‘ç·šç´¢ (ä¸è¦å¯«æ­»æ•¸å­—) ---
        
        // A. ç®—å‡ºæª”æ¡ˆ (profiles) æœ‰å¹¾å€‹ï¼šç›´æ¥ç®— profiles è£¡é¢çš„åå­—æ•¸é‡
        const totalProfiles = Object.keys(contentData.profiles).length;

        // B. ç®—å‡ºç·šç´¢ (clues) æœ‰å¹¾å€‹ï¼šå› ç‚ºç·šç´¢åŒ…åœ¨ä¸åŒäººåä¸‹ï¼Œæ‰€ä»¥è¦è½‰å€‹å½ç®—
        // é‚è¼¯ï¼šæŠŠæ¯ä¸€å€‹è§’è‰²åº•ä¸‹çš„ç·šç´¢æ•¸é‡åŠ ç¸½èµ·ä¾†
        const totalClues = Object.keys(contentData.clues).reduce((acc, key) => {
            const val = contentData.clues[key];
            // å¦‚æœè£¡é¢é‚„æœ‰ç´°é … (ä¾‹å¦‚ spark è£¡é¢æœ‰ engine å’Œ hook)ï¼Œå°±åŠ ä¸Šç´°é …çš„æ•¸é‡
            if (typeof val === 'object') {
                return acc + Object.keys(val).length;
            }
            // å¦‚æœåªæ˜¯å–®ç´”ä¸€æ®µæ–‡å­—ï¼Œå°±åŠ  1
            return acc + 1;
        }, 0);
        
        // ç¸½æ•¸ = æª”æ¡ˆæ•¸ + ç·šç´¢æ•¸
        const totalEvidence = totalProfiles + totalClues; 
        
        // ç®—å‡ºç™¾åˆ†æ¯” (ä¾‹å¦‚ 0.75 ä»£è¡¨ 75%)
        const coverageRate = (evidenceCount / totalEvidence).toFixed(2);

        // --- æ­¥é©Ÿ 3ï¼šå‚³é€æ•¸æ“šçµ¦ GA4 ---
        if (name === 'é­¯é“å¤«') {
            const durationSec = Math.floor((Date.now() - (gameState.startTime || Date.now())) / 1000);
            trackGameEvent('game_complete', {
                result: 'success',
                mistakes: gameState.wrongAccusationCount,
                total_duration_sec: durationSec, 
                total_actions: gameState.actionTotal,
                evidence_coverage: coverageRate, // é€™æ˜¯ä½ çš„æ ¸å¿ƒæ•¸æ“šï¼šè­‰æ“šå®Œæ•´åº¦
                evidence_count: evidenceCount    // é€™æ˜¯ç©å®¶å¯¦éš›æ‰¾åˆ°çš„æ•¸é‡
            });
            renderScene('ending_confession');
            playConfessionSequence();
        } else {
            const isSamePerson = (gameState.lastAccused === name);
            gameState.lastAccused = name; 
            gameState.wrongAccusationCount++;
            trackGameEvent('accusation_failed', {
                accused_char: name,
                current_mistakes: gameState.wrongAccusationCount,
                evidence_coverage: coverageRate, // å³ä½¿å¤±æ•—ï¼Œä¹Ÿç´€éŒ„ä»–æ˜¯æ†‘å¤šå°‘è­‰æ“šçŒœçš„
                evidence_count: evidenceCount
            });
            if (isSamePerson) {
                playAngryDenialSequence(name);
            } else {
                if (gameState.wrongAccusationCount === 1) {
                    playDenialSequence(name);
                } else {
                    playInterruptedDenialSequence(name);
                }
            }
        }
    }

    function playAngryDenialSequence(name) {
        if (name === 'å²æ´¾å…‹') scenes['accuse_denial'].image = 'spark_denial_2.jpg';
        else if (name === 'åº«å¥‡') scenes['accuse_denial'].image = 'cookie_denial_2.jpg';

        renderScene('accuse_denial');
        gameState.sceneLogs['accuse_denial'] = '';
        document.getElementById('feedback-area').innerHTML = '';

        let angryLines = [];
        if (name === 'å²æ´¾å…‹') {
            angryLines = [
                {t: "ä½ çš„é‚è¼¯é›»è·¯ç‡’å£äº†å—ï¼Ÿï¼", type: "char", name: "å²æ´¾å…‹"},
                {t: "å²æ´¾å…‹æ°£å¾—å…¨èº«ç™¼æŠ–ï¼Œç”¨åŠ›æŠŠæ‰³æ‰‹ç ¸åœ¨æ¡Œä¸Šï¼", type: "system"},
                {t: "æˆ‘èªªéä¸æ˜¯æˆ‘ï¼è¦æ˜¯å†èª£è³´æˆ‘ï¼Œæˆ‘å°±æŠŠä½ çš„é›ªæ©‡æ‹†æˆå»¢éµï¼", type: "char", name: "å²æ´¾å…‹"},
                {t: "ç§‘å­¸å®¶æ˜¯ä¸æœƒèªªè¬Šçš„ï¼æ°£æ­»æˆ‘äº†ï¼", type: "char", name: "å²æ´¾å…‹"}
            ];
        } else if (name === 'åº«å¥‡') {
            angryLines = [
                {t: "å™¢ï¼ä½ é€™å€‹æ²’ç¦®è²Œçš„åµæ¢ï¼", type: "char", name: "åº«å¥‡"},
                {t: "åº«å¥‡æ°£å¾—è‡‰æ¼²æˆäº†ç´…è‰²ï¼Œæ‰‹ä¸­çš„æ“ èŠ±è¢‹è¢«æå¾—è®Šå½¢ï¼Œç³–éœœå™´å¾—åˆ°è™•éƒ½æ˜¯ã€‚", type: "system"},
                {t: "æˆ‘èªªäº†æ²’æœ‰æ™‚é–“ï¼æˆ‘çš„è–‘é¤…å¿«çƒ¤ç„¦äº†ï¼ä½ é‚„è¦æµªè²»æˆ‘å¤šå°‘æ™‚é–“ï¼", type: "char", name: "åº«å¥‡"},
                {t: "å‡ºå»ï¼ä¸è¦å¦¨ç¤™æˆ‘çš„ç¥è–çƒ˜ç„™æ™‚åˆ»ï¼", type: "char", name: "åº«å¥‡"}
            ];
        } else {
            angryLines = [{t: "æˆ‘çœŸçš„ç”Ÿæ°£äº†ï¼ä¸æ˜¯æˆ‘ï¼", type: "char", name: name}];
        }
        
        runDialogueSequence(angryLines, () => {
            playAutoConfessionSequence();
        });
    }

    function playDenialSequence(name) {
        if (name === 'å²æ´¾å…‹') scenes['accuse_denial'].image = 'spark_denial_1.jpg';
        else if (name === 'åº«å¥‡') scenes['accuse_denial'].image = 'cookie_denial_1.jpg';

        renderScene('accuse_denial');
        gameState.sceneLogs['accuse_denial'] = '';
        document.getElementById('feedback-area').innerHTML = '';

        let denialLines = [];
        if (name === 'å²æ´¾å…‹') {
            denialLines = [
                {t: "ä»€éº¼ï¼Ÿæˆ‘ï¼Ÿ", type: "char", name: "å²æ´¾å…‹"},
                {t: "å²æ´¾å…‹çªå¤§äº†çœ¼ç›ï¼Œæ°£å¾—æ‰³æ‰‹éƒ½æ‰åœ¨åœ°ä¸Šã€‚", type: "system"},
                {t: "åµæ¢ï¼Œä½ çœ‹çœ‹æˆ‘çš„æ‰‹ï¼é€™æ©Ÿæ²¹è¦æ˜¯æ‘¸åˆ°é‚£å€‹é‡‘å…‰é–ƒé–ƒçš„é½’è¼ªï¼Œæ—©å°±ç•™ä¸‹æ‰‹å°äº†ï¼", type: "char", name: "å²æ´¾å…‹"}, 
                {t: "æˆ‘æ‰ä¸æœƒçŠ¯é€™ç¨®ä½ç´šéŒ¯èª¤ï¼", type: "char", name: "å²æ´¾å…‹"}
            ];
        } else if (name === 'åº«å¥‡') {
            denialLines = [
                {t: "å¤©å•Šï¼ä½ æ‡·ç–‘æˆ‘ï¼Ÿ", type: "char", name: "åº«å¥‡"},
                {t: "åº«å¥‡åš‡å¾—å·®é»æŠŠæ‰‹ä¸Šçš„æ“ èŠ±è¢‹æçˆ†ã€‚", type: "system"},
                {t: "æˆ‘åªæ˜¯ä¸€å€‹å»šå¸«ï¼æˆ‘è¦æ€éº¼çˆ¬ä¸Š 20 å…¬å°ºçš„é«˜å¡”ï¼Ÿ", type: "char", name: "åº«å¥‡"},
                {t: "è€Œä¸”æˆ‘çš„ç¥è–çš„ç³–éœœæ˜¯ç”¨ä¾†è£é£¾çš„ï¼Œä¸æ˜¯ç”¨ä¾†ç•¶è­‰ç‰©çš„ï¼", type: "char", name: "åº«å¥‡"}
            ];
        }

        runDialogueSequence(denialLines, () => {
            const menu = document.getElementById('interaction-bar');
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.innerText = "ğŸ”™ é‡æ–°æ€è€ƒ";
            btn.onclick = () => playAccusationSequence(); 
            menu.appendChild(btn);
        });
    }

    function playInterruptedDenialSequence(name) {
        if (name === 'å²æ´¾å…‹') scenes['accuse_denial'].image = 'spark_denial_1.jpg';
        else if (name === 'åº«å¥‡') scenes['accuse_denial'].image = 'cookie_denial_1.jpg';

        renderScene('accuse_denial');
        gameState.sceneLogs['accuse_denial'] = '';
        document.getElementById('feedback-area').innerHTML = '';

        let startLines = [];
        if (name === 'å²æ´¾å…‹') {
            startLines = [{t: "ä½ æéŒ¯äº†ï¼æˆ‘æ ¹æœ¬æ²’åš...", type: "char", name: "å²æ´¾å…‹"}];
        } else if (name === 'åº«å¥‡') {
            startLines = [{t: "çœŸçš„ä¸æ˜¯æˆ‘ï¼æˆ‘å°è–èª•è€äººç™¼èª“...", type: "char", name: "åº«å¥‡"}];
        }
        
        runDialogueSequence(startLines, () => {
            playAutoConfessionSequence();
        });
    }

    function playAutoConfessionSequence() {
        document.getElementById('interaction-bar').innerHTML = '';
        runDialogueSequence([
            {t: "...ç­‰ç­‰ï¼", type: "mystery"}
        ], () => {
            const menu = document.getElementById('interaction-bar');
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.innerText = "ğŸ‘€ æŸ¥çœ‹è²éŸ³ä¾†æº";
            btn.onclick = () => handleAction('ending:reveal_culprit'); 
            menu.appendChild(btn);
        });
    }

    function playConfessionSequence(skipIntro = false) {
        if (!skipIntro) {
            document.getElementById('feedback-area').innerHTML = '';
            gameState.sceneLogs['ending_confession'] = '';
        }

        let lines = [];
        if (!skipIntro) {
            lines = [
                {t: "è¢«æŒ‡èªå¾Œï¼Œé­¯é“å¤«åƒµåœ¨åŸåœ°ã€‚", type: "system"},
                {t: "ä»–ä¸‹æ„è­˜åœ°èˆ”äº†ä¸€ä¸‹å˜´è§’çš„è—è‰²ç³–ç²‰ï¼Œçœ¼ç›è£¡é–ƒçˆè‘—æ·šæ°´ã€‚", type: "system"},
                {t: "å°ä¸èµ·... æˆ‘çœŸçš„å¤ªç´¯äº†ã€‚", type: "char", name: "é­¯é“å¤«"}
            ];
        }

        lines.push(
            {t: "æ¯å¹´ç¦®ç‰©è¶Šä¾†è¶Šé‡... æˆ‘æ€•æˆ‘é£›ä¸å‹•äº†...", type: "char", name: "é­¯é“å¤«"},
            {t: "æˆ‘ä»¥ç‚ºåªè¦æ‹¿èµ°é½’è¼ªï¼Œæ™‚é–“åœä½ï¼Œæˆ‘å°±ä¸ç”¨é¢å°é€™ä¸€åˆ‡äº†ã€‚", type: "char", name: "é­¯é“å¤«"},
            {t: "é­¯é“å¤«é¡«æŠ–è‘—ä¸çŸ¥é“å¾ä½•è™•ï¼Œç·©ç·©æ¨å¾—é‚£æšé–ƒè€€è‘—é‡‘è‰²å…‰èŠ’çš„é½’è¼ªã€‚", type: "system"},
            {t: "ä»–ä½ä¸‹é ­ï¼Œå°‡é½’è¼ªæ»‘åˆ°äº†ä½ çš„è…³é‚Šã€‚", type: "system"}
        );
        runDialogueSequence(lines, () => {
            const menu = document.getElementById('interaction-bar');
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.innerText = "ğŸ”¹ é€™ä¸æ˜¯ä½ ä¸€å€‹äººçš„è²¬ä»»...";
            btn.onclick = () => handleAction('ending:teamwork');
            menu.appendChild(btn);
        });
    }

    function playEndingTeamworkSequence() {
        scenes['ending_teamwork'].choices = [
            { text: "ğŸ”¹ å²æ´¾å…‹æœ‰è©±è¦èªª", action: "ending:team_spark" }
        ];
        renderScene('ending_teamwork');
        gameState.sceneLogs['ending_teamwork'] = '';
        document.getElementById('feedback-area').innerHTML = '';
        
        runDialogueSequence([
            {t: "ä½ çœ‹è‘—é­¯é“å¤«å‚é ­å–ªæ°£çš„æ¨£å­ï¼Œæ­£æƒ³é–‹å£...", type: "system"}
        ], () => {
            renderButtons(scenes['ending_teamwork']);
        });
    }

    function handleAction(actionStr, btnText) {
        // --- ä¿®æ”¹é» 3ï¼šä½¿ç”¨è€…äº’å‹•å³è§¸ç™¼éŸ³æ¨‚ (è‡ªå‹•æ·¡å…¥) ---
        tryInitMusic();
        
        playSound('click');
        clickArea.removeEventListener('click', processNextDialogueLine);
        isDialogueRunning = false;

        clearTimeout(dialogueTimer); 

        // --- ä¿®æ”¹é» 1ï¼šé™åˆ¶ç·šç´¢åªèƒ½é»ä¸€æ¬¡ ---
        // é€™è£¡åŠ å…¥äº† returnï¼Œæ‰€ä»¥å¦‚æœç©å®¶å·²ç¶“é»éï¼Œå°±ä¸æœƒå†é¡¯ç¤ºå°è©±ã€‚
        const [type, target] = actionStr.split(':');
        if (gameState.usedActions.has(actionStr)) {
            if (type === 'check' || type === 'read') {
                 trackGameEvent('revisit_clue', {
                    target_clue: target,
                    scene: gameState.currentScene
                });
                return; // åŠ å…¥äº† returnï¼Œç¬¦åˆä½ è¦æ±‚çš„ã€Œä¸èƒ½å†é‡è¤‡é¡¯ç¤ºã€
            }
        }
        
        gameState.usedActions.add(actionStr);
        gameState.actionTotal = (gameState.actionTotal || 0) + 1; 

        let interactionType = 'menu_button';
        if (btnText && (btnText.includes('ğŸš€') || btnText.includes('ğŸ©') || btnText.includes('ğŸ“'))) {
            interactionType = 'visual_hotspot';
        }

        trackGameEvent('player_choice', {
            action_type: type,      
            action_target: target,  
            label: btnText || 'unknown', 
            interaction_source: interactionType, 
            move_number: gameState.actionTotal   
        });
        saveGameState(); 

        if (actionStr === 'open_survey') {
            window.open('https://forms.gle/7AExAzyq7ACQnaX57', '_blank');
            return;
        }
        
        if (actionStr === 'start_game') {
            trackGameEvent('game_start', { timestamp: Date.now() });
            currentTrackId = 'bgm-main'; 
            tryInitMusic(); // ç¢ºä¿é–‹å§‹éŠæˆ²æ™‚éŸ³æ¨‚æœƒæ’­æ”¾
            renderScene('opening_frozen');
            return;
        }

        if (actionStr === 'play_prologue') {
            playPrologueSequence();
            return;
        }

        if (actionStr === 'reload') {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
            return;
        }

        if (type === 'goto') {
            renderScene(target);
        } 
        else if (type === 'read') {
            runDialogueSequence([{t: contentData.profiles[target], type: 'system'}]);
        } 
        else if (type === 'check') {
            let text = "";
            if(contentData.clues[target]) {
                text = contentData.clues[target];
            } else {
                if (target === 'engine') text = contentData.clues.spark.engine;
                else if (target === 'grappling_hook') text = contentData.clues.spark.grappling_hook;
                else if (target === 'cookie_powder') text = contentData.clues.cookie.cookie_powder;
                else if (target === 'blueprint_sketch') text = contentData.clues.cookie.blueprint_sketch;
                else if (target === 'window_trace') text = contentData.clues.tower.window_trace;
                else if (target === 'blue_powder_scene') text = contentData.clues.tower.blue_powder_scene;
                else if (target === 'donut_box') text = contentData.clues.rudolph.donut_box;
                else if (target === 'blanket_hidden') text = contentData.clues.rudolph.blanket_hidden;
            }
            runDialogueSequence([{t: text, type: 'system'}]);
        } 
        else if (type === 'check_lock') {
            if (target === 'tower_top') {
                if (gameState.hasKey) {
                    renderScene('tower_top');
                } else {
                    const feedback = document.getElementById('feedback-area');
                    if (feedback.lastElementChild && feedback.lastElementChild.textContent.includes("çœ‹ä¾†æ²’æœ‰é‘°åŒ™")) {
                        const bubbles = feedback.querySelectorAll('.bubble');
                        const lastTwo = Array.from(bubbles).slice(-2);
                        lastTwo.forEach(el => {
                            el.classList.remove('shake');
                            void el.offsetWidth; 
                            el.classList.add('shake');
                        });
                        return; 
                    }
                    runDialogueSequence([
                        {t: "ï¼ˆæ‹‰äº†æ‹‰é–€æŠŠï¼‰é–€é–å¾—æ­»æ­»çš„ã€‚", type: 'system'},
                        {t: "çœ‹ä¾†æ²’æœ‰é‘°åŒ™æ˜¯é€²ä¸å»çš„ã€‚æ‡‰è©²å»æ‰¾ã€Œç®¡ç†é‘°åŒ™çš„äººã€å•å•ï¼Ÿ", type: 'system'}
                    ]);
                }
            }
            return;
        }
        else if (type === 'chat') {
            let chatLines = [];
            if(btnText) {
                chatLines.push({t: btnText, type: 'player'});
            }
            if (target === 'barnaby_key') {
                if (gameState.hasKey) {
                    chatLines.push({t: "ä½ å·²ç¶“æ‹¿åˆ°é‘°åŒ™äº†ã€‚", type: 'system'});
                } else {
                    gameState.hasKey = true;
                    chatLines.push(
                        {t: "ç•¶ç„¶å¯ä»¥ï¼Œåµæ¢ã€‚", type: 'char', name: 'å·´ç´æ¯”'},
                        {t: "é€™é‘°åŒ™æˆ‘ä¸€ç›´æ›åœ¨è„–å­ä¸Šæ²’é›¢èº«éï¼Œçµ•å°æ²’äººå·ç”¨éï¼", type: 'char', name: 'å·´ç´æ¯”'},
                        {t: "ï¼ˆç²å¾—äº†é˜æ¨“å¤§é–€é‘°åŒ™ï¼ç¾åœ¨å¯ä»¥é€²å…¥å¡”é ‚äº†ï¼‰", type: 'system'}
                    );
                }
            }
            else if (target === 'barnaby_spark') {
                chatLines.push(
                    {t: "å²æ´¾å…‹æœ€è¿‘ç‚ºäº†èƒ½æºå¿«ç™¼ç˜‹äº†ã€‚", type: 'char', name: 'å·´ç´æ¯”'},
                    {t: "ä»–æœ‰å€‹ä¼¸ç¸®çˆªå­ç†è«–ä¸Šèƒ½æŠ“åˆ°å¡”é ‚çš„æ±è¥¿ï¼Œä½†é‚£ç ´æ©Ÿå™¨æ¼æ²¹æ¼å¾ˆå…‡ï¼Œæ“ä½œä¹Ÿä¸ç©©... çœŸçš„èƒ½æ‹†å¸ç²¾å¯†é½’è¼ªå—ï¼Ÿ", type: 'char', name: 'å·´ç´æ¯”'}
                );
            }
            else if (target === 'barnaby_cookie') {
                chatLines.push(
                    {t: "åº«å¥‡æ°£æˆ‘æ­»ä¸å€Ÿä»–é‘°åŒ™ï¼Œä»–æ›¾å¤§å¼èªªã€æˆ‘è‡ªå·±æƒ³è¾¦æ³•é€²å»ã€ï¼", type: 'char', name: 'å·´ç´æ¯”'},
                    {t: "ä½†ä»–æ²’æœ‰æ¢¯å­ï¼Œé«”å‹ä¹Ÿä¸é©åˆçˆ¬é€šé¢¨ç®¡... é™¤éä»–æŠŠè–‘é¤…ç–Šèµ·ä¾†ç•¶æ¨“æ¢¯ï¼Ÿå“ˆå“ˆã€‚", type: 'char', name: 'å·´ç´æ¯”'}
                );
            }
            else if (target === 'barnaby_rudolph') {
                chatLines.push(
                    {t: "é­¯é“å¤«æœ€è¿‘å¾ˆåå¸¸ï¼Œè½åˆ°é£›è¡ŒæŒ‡ä»¤å°±æœƒç™¼æŠ–ã€‚", type: 'char', name: 'å·´ç´æ¯”'},
                    {t: "ä¸éèªªåˆ°ä¸é æ¢¯å­å°±èƒ½ä¸Šå¡”é ‚... å…¨æ‘å¥½åƒä¹Ÿåªæœ‰æœƒé£›çš„é¦´é¹¿åšå¾—åˆ°ï¼Ÿ", type: 'char', name: 'å·´ç´æ¯”'},
                    {t: "å•Šï¼æˆ‘ä¸æ˜¯åœ¨æ‡·ç–‘ä»–å•¦ï¼", type: 'char', name: 'å·´ç´æ¯”'}
                );
            }
            else if (target === 'spark_alibi') {
                chatLines.push(
                    {t: "æˆ‘åœ¨åšä»€éº¼ï¼Ÿæˆ‘åœ¨è©¦åœ–æ‹¯æ•‘è–èª•ç¯€çš„ç‰©æµç³»çµ±ï¼", type: 'char', name: 'å²æ´¾å…‹'},
                    {t: "é€™å°å¼•æ“éœ€è¦å¼·å¤§çš„å‹•åŠ›æºã€‚æˆ‘æ•´æ™šéƒ½åœ¨è¨ˆç®—æ•¸æ“šï¼Œæƒ³è¾¦æ³•æ‰¾æ›¿ä»£èƒ½æº...", type: 'char', name: 'å²æ´¾å…‹'},
                    {t: "ä½†æˆ‘ç™¼èª“ï¼Œæˆ‘æ•´æ™šéƒ½åœ¨å¯¦é©—å®¤è£¡ï¼Œå“ªå…’ä¹Ÿæ²’å»ã€‚", type: 'char', name: 'å²æ´¾å…‹'}
                );
            } else if (target === 'spark_suspect') {
                chatLines.push(
                    {t: "å¦‚æœä½ å•æˆ‘ï¼Œæˆ‘é‚„æ˜¯è¦ºå¾—é«˜è™•æœ‰å•é¡Œã€‚", type: 'char', name: 'å²æ´¾å…‹'},
                    {t: "æˆ‘åŠå¤œåäºŒé»å‰æœ‰çŸ­æš«å‡ºå»ä¸€ä¸‹ã€‚", type: 'char', name: 'å²æ´¾å…‹'},
                    {t: "é‚£æ™‚é›–ç„¶åœ°é¢ç„¡é¢¨ï¼Œä½†æˆ‘çœ‹åˆ°å¡”é ‚çš„é¢¨å‘æ¨™åœ¨ç˜‹ç‹‚æ—‹è½‰ã€‚é‚£è£¡è‚¯å®šæœ‰æ°£æµæ“¾å‹•ã€‚", type: 'char', name: 'å²æ´¾å…‹'} 
                );
            } else if (target === 'spark_tool') {
                chatLines.push(
                    {t: "ï¼ˆå²æ´¾å…‹çœ¼ç¥æ¸¸ç§»äº†ä¸€ä¸‹ï¼‰é‚£å€‹ï¼Ÿé‚£åªæ˜¯å€‹... å·¥æ¥­ç”¨çš„å¤¾å¨ƒå¨ƒæ©Ÿã€‚", type: 'char', name: 'å²æ´¾å…‹'},
                    {t: "é€™æ˜¯æˆ‘çš„å‰å¤§ç™¼æ˜ï¼åªè¦åœ¨ 20 å…¬å°ºå…§ï¼Œæˆ‘å°±èƒ½å¸å–ä»»ä½•é‡‘å±¬ï¼", type: 'char', name: 'å²æ´¾å…‹'},
                    {t: "åˆ¥ç¢°å®ƒï¼å¾ˆç²¾å¯†çš„... è€Œä¸”ä¸Šé¢éƒ½æ˜¯æ²¹ã€‚", type: 'char', name: 'å²æ´¾å…‹'} 
                );
            }
            else if (target === 'cookie_alibi') {
                chatLines.push(
                    {t: "æˆ‘åœ¨ 11:45 å®Œæˆäº†è—è‰²æ˜Ÿå¡µç”œç”œåœˆçš„è£é£¾ã€‚", type: 'char', name: 'åº«å¥‡'},
                    {t: "ä¹‹å¾Œæˆ‘å¸¶è‘—ç›’å­å»äº†é¦¬å»„ï¼ŒæŠŠç”œç”œåœˆæ”¾åœ¨é­¯é“å¤«çš„é£Ÿæ§½æ—é‚Šã€‚é‚£æ™‚å€™ä»–åœ¨ç¡è¦ºï¼Œæˆ‘å°±æ²’å«é†’ä»–ï¼Œç›´æ¥é›¢é–‹äº†ã€‚", type: 'char', name: 'åº«å¥‡'}
                );
            } else if (target === 'cookie_suspect') {
                chatLines.push(
                    {t: "æˆ‘è¦ºå¾—æ˜¯å²æ´¾å…‹ã€‚", type: 'char', name: 'åº«å¥‡'},
                    {t: "ä»–ä¸€ç›´æƒ³æŠŠé‚£å€‹é½’è¼ªæ‹†ä¸‹ä¾†ç ”ç©¶ã€‚è€Œä¸”ä»–æ‰‹é‚£éº¼é«’ï¼Œå¤§æ¦‚é€£ä½œæ¡ˆç¾å ´éƒ½æœƒå¼„é«’å§ï¼Ÿ", type: 'char', name: 'åº«å¥‡'}
                );
            } else if (target === 'cookie_sketch') {
                chatLines.push(
                    {t: "é€™å¼µåœ–ï¼Ÿé€™æ˜¯æˆ‘ç‚ºäº†è–èª•æ´¾å°æº–å‚™çš„ã€Œé©šå–œå¤§è›‹ç³•ã€è¨­è¨ˆåœ–ï¼", type: 'char', name: 'åº«å¥‡'},
                    {t: "æˆ‘æ‰“ç®—çƒ¤ä¸€å€‹è·Ÿé˜æ¨“é½’è¼ªä¸€æ¨¡ä¸€æ¨£çš„è–‘é¤…ï¼Œæ”¾åœ¨å¡”é ‚è£é£¾ã€‚", type: 'char', name: 'åº«å¥‡'},
                    {t: "ã€Œä»¥å‡äº‚çœŸã€æ˜¯æŒ‡ç³–éœœçš„å…‰æ¾¤æ„Ÿå•¦ï¼ä½ å€‘åµæ¢éƒ½é€™éº¼æ•æ„Ÿå—ï¼Ÿ", type: 'char', name: 'åº«å¥‡'}
                );
            }
            else if (target === 'rudolph_alibi') {
                chatLines.push(
                    {t: "ï¼ˆé­¯é“å¤«æ‰“äº†ä¸€å€‹é•·é•·çš„å“ˆæ¬ ï¼‰", type: 'system'},
                    {t: "å¾æ™šä¸Šåé»ç†„ç‡ˆå¾Œï¼Œæˆ‘å°±ä¸€ç›´åœ¨é€™è£¡ç¡è¦ºã€‚", type: 'char', name: "é­¯é“å¤«"},
                    {t: "è–èª•ç¯€çš„é£›è¡Œä»»å‹™å¾ˆé‡è¦ï¼Œæˆ‘å¿…é ˆå„²å‚™é«”åŠ›... æ‹œè¨—ï¼Œè®“æˆ‘å¤šç¡ä¸€æœƒå§ã€‚", type: 'char', name: "é­¯é“å¤«"} 
                );
            } else if (target === 'rudolph_suspect') {
                chatLines.push(
                    {t: "æˆ‘ç¡å¾—å¾ˆæ­»ï¼Œä»€éº¼éƒ½æ²’è½åˆ°ï¼Œä¹Ÿæ²’çœ‹åˆ°ã€‚", type: 'char', name: "é­¯é“å¤«"},
                    {t: "ä¹Ÿè¨±ä½ å¯ä»¥å»å•å•é‚£äº›é‚„é†’è‘—çš„äººï¼Ÿä¸è¦ç‚ºé›£æˆ‘é€™éš»æƒ³ç¡è¦ºçš„é¦´é¹¿äº†ã€‚", type: 'char', name: "é­¯é“å¤«"} 
                );
            } else if (target === 'rudolph_powder') {
                chatLines.push(
                    {t: "ç²‰æœ«ï¼Ÿ...å™¢ã€‚", type: 'char', name: "é­¯é“å¤«"},
                    {t: "å¤§æ¦‚æ˜¯åº«å¥‡é€é»å¿ƒä¾†çš„æ™‚å€™å¼„å¾—åˆ°è™•éƒ½æ˜¯å§ã€‚ä½ çŸ¥é“ä»–é‚£å€‹äººï¼Œå‹•ä½œç¸½æ˜¯å¾ˆå¤§ã€‚", type: 'char', name: "é­¯é“å¤«"},
                    {t: "é€™æ‡‰è©²ä¸çŠ¯æ³•å§ï¼Ÿæ²¾åˆ°ä¸€é»ç³–ç²‰ï¼Ÿ", type: 'char', name: "é­¯é“å¤«"} 
                );
            } else {
                chatLines.push({t: "...", type: 'char', name: 'NPC'});
            }
            runDialogueSequence(chatLines);
        }
        else if (type === 'pre_accuse') {
            if(!confirm("âš ï¸ è­¦å‘Šï¼šæŒ‡èªæ©Ÿæœƒåƒ…æœ‰å…©æ¬¡ã€‚\nè«‹ç¢ºèªä½ å·²æŒæ¡ã€ŒçŠ¯æ¡ˆæ‰‹æ®µã€èˆ‡ã€Œé—œéµè­‰ç‰©ã€çš„é€£çµã€‚\n\nç¢ºå®šè¦ç¾åœ¨æŒ‡èªå—ï¼Ÿ")) return;
            playAccusationSequence(); 
        }
        else if (type === 'ending') {
            if (target === 'teamwork') {
                playEndingTeamworkSequence();
            } 
            else if (target === 'reveal_culprit') {
                renderScene('ending_confession');
                gameState.sceneLogs['ending_confession'] = '';
                document.getElementById('feedback-area').innerHTML = '';
                
                runDialogueSequence([
                    {t: "åˆ¥å†çŒœäº†ï¼", type: "char", name: "é­¯é“å¤«"},
                    {t: "é­¯é“å¤«çªç„¶ç«™äº†å‡ºä¾†ï¼Œæ‰“æ–·äº†å°è©±ã€‚", type: "system"},
                    {t: "ä¸æ˜¯ä»–å€‘... æ˜¯æˆ‘ã€‚æ˜¯æˆ‘åšçš„ã€‚", type: "char", name: "é­¯é“å¤«"},
                    {t: "æˆ‘ä¸å¸Œæœ›å› ç‚ºæˆ‘çš„è‡ªç§ï¼Œè®“å…¶ä»–äººè¢«èª¤æœƒã€‚", type: "char", name: "é­¯é“å¤«"},
                    {t: "å°ä¸èµ·... æˆ‘çœŸçš„å¾ˆæŠ±æ­‰ã€‚", type: "char", name: "é­¯é“å¤«"}
                ], () => {
                    playConfessionSequence(true); 
                });
            }
            else if (target === 'team_spark') {
                runDialogueSequence([
                    {t: "å²æ´¾å…‹è¡ä¸Šå‰ï¼Œç”¨åŠ›æ‹äº†æ‹é­¯é“å¤«çš„èƒŒã€‚", type: "system"},
                    {t: "å‚»ç“œï¼ä½ ä»¥ç‚ºæˆ‘åšé‚£äº›ç«ç®­æ˜¯ç‚ºäº†ä»€éº¼ï¼Ÿ", type: "char", name: "å²æ´¾å…‹"},
                    {t: "å°±æ˜¯ç‚ºäº†å¹«ä½ åœ¨èµ·é£›æ™‚æ¨é€²å•Šï¼ä»Šå¹´æˆ‘å€‘å¯ä»¥ç”¨è¼”åŠ©å¼•æ“ä¾†å¹«ä½ é£›è¡Œï¼", type: "char", name: "å²æ´¾å…‹"}
                ], () => {
                    scenes['ending_teamwork'].choices = [{ text: "ğŸ”¹ åº«å¥‡æ‹¿å‡ºäº†æ±è¥¿", action: "ending:team_cookie" }];
                    renderButtons(scenes['ending_teamwork']);
                });
            } else if (target === 'team_cookie') {
                runDialogueSequence([
                    {t: "åº«å¥‡å¾å£è¢‹æå‡ºä¸€å¡Šç†±é¨°é¨°çš„è–‘é¤…ï¼Œéäº†éå»ã€‚", type: "system"},
                    {t: "é‚„æœ‰é€™å€‹ï¼é€™è£¡é¢åŠ äº†é›™å€çš„å¿«æ¨‚é­”æ³•ç³–éœœã€‚", type: "char", name: "åº«å¥‡"},
                    {t: "åƒä¸‹å»ï¼Œä½ æœƒè¦ºå¾—è¼•é£„é£„çš„ï¼", type: "char", name: "åº«å¥‡"}
                ], () => {
                    scenes['ending_teamwork'].choices = [{ text: "ğŸ”¹ å·´ç´æ¯”çš„ç¸½çµ", action: "ending:team_barnaby" }];
                    renderButtons(scenes['ending_teamwork']);
                });
            } else if (target === 'team_barnaby') {
                runDialogueSequence([
                    {t: "å·´ç´æ¯”èµ°åˆ°é­¯é“å¤«é¢å‰ã€‚", type: "system"},
                    {t: "åµæ¢æ‰¾å‡ºäº†çœŸç›¸ï¼Œä½†è§£æ±ºå•é¡Œéœ€è¦æˆ‘å€‘å¤§å®¶ã€‚", type: "char", name: "å·´ç´æ¯”"}, 
                    {t: "é­¯é“å¤«ï¼Œä½ æ˜¯æˆ‘å€‘çš„é ˜èˆªå“¡ï¼Œæ²’æœ‰ä½ ï¼Œæˆ‘å€‘èª°ä¹Ÿå»ä¸äº†ã€‚", type: "char", name: "å·´ç´æ¯”"},
                    {t: "é­¯é“å¤«æ“¦ä¹¾çœ¼æ·šï¼Œç´…é¼»å­å¾®å¾®ç™¼äº®ã€‚", type: "system"},
                    {t: "è¬è¬... è¬è¬ä½ å€‘ã€‚é‚£æˆ‘å€‘... å‡ºç™¼å§ï¼Ÿ", type: "char", name: "é­¯é“å¤«"}
                ], () => {
                    scenes['ending_teamwork'].choices = [{ text: "âš™ï¸ ä¿®å¾©æ™‚é–“ï¼Œå•Ÿå‹•è–èª•ç¯€ï¼", action: "ending:fix_gear" }];
                    renderButtons(scenes['ending_teamwork']);
                });
            }
            else if (target === 'fix_gear') {
                playEndingFixGearSequence();
            } else if (target === 'santa_reveal') {
                renderScene('ending_santa_reveal');
                gameState.sceneLogs['ending_santa_reveal'] = '';
                document.getElementById('feedback-area').innerHTML = '';

                runDialogueSequence([
                    {t: "Ho Ho Hoï¼åšå¾—å¥½å•Šï¼Œå„ä½ï¼", type: 'santa'}, 
                    {t: "ï¼ˆå¤§å®¶é©šè¨åœ°æŠ¬èµ·é ­ï¼Œå°‹æ‰¾è²éŸ³çš„ä¾†æº...ï¼‰", type: 'system'}
                ], () => {
                      const menu = document.getElementById('interaction-bar');
                      const btn = document.createElement('button');
                      btn.className = 'choice-btn';
                      btn.innerText = "ğŸ”¹ è½‰èº«çœ‹æ˜¯èª°ï¼Ÿ";
                      btn.onclick = () => handleAction('ending:show_face'); 
                      menu.appendChild(btn);
                });
            } else if (target === 'show_face') {
                renderScene('ending_real_face');
                runDialogueSequence([
                    {t: "æ˜¯è–èª•è€äººï¼", type: 'system'},
                    {t: "åµæ¢ï¼Œé‚„è¨˜å¾—é‚£å°é‚€è«‹å‡½å—ï¼Ÿ", type: 'santa'},
                    {t: "æˆ‘å¯«è‘—ã€Œä»Šæ™šæœƒæœ‰å¤§äº‹ç™¼ç”Ÿã€ã€‚æˆ‘æŒ‡çš„ä¸æ˜¯å¤±ç«Šï¼Œè€Œæ˜¯ä½ å€‘çš„ã€Œåœ˜åœ“ã€ã€‚", type: 'santa'},
                    {t: "é­¯é“å¤«ï¼Œä¸éœ€è¦ç¨è‡ªæ‰¿æ“”ä¸€åˆ‡ã€‚çœŸæ­£çš„è–èª•é­”æ³•ï¼Œå¾ä¾†ä¸æ˜¯ç¦®ç‰©ï¼Œè€Œæ˜¯å½¼æ­¤æ‰¶æŒçš„å¿ƒã€‚", type: 'santa'},
                    {t: "Merry Christmasï¼å­©å­å€‘é‚„åœ¨ç­‰è‘—æˆ‘å€‘å‘¢ï¼Œä¸Šå·¥å›‰ï¼", type: 'santa'}
                ], () => {
                    trackGameEvent('ending_complete', {
                        total_duration: Math.floor((Date.now() - gameState.startTime) / 1000),
                        mistakes: gameState.wrongAccusationCount
                    });

                    const menu = document.getElementById('interaction-bar');
                    const btn = document.createElement('button');
                    btn.className = 'choice-btn replay-btn';
                    btn.innerText = "ğŸ¬ å®Œçµ";
                    btn.onclick = () => handleAction('goto:game_fin');
                    menu.appendChild(btn);
                });
            }
        }
    }

    function showResumePrompt() {
        const vis = document.getElementById('visual-panel');
        const header = document.getElementById('scene-title');
        const feedback = document.getElementById('feedback-area');
        const menu = document.getElementById('interaction-bar');
        
        clearTimeout(dialogueTimer); 
        clickArea.removeEventListener('click', processNextDialogueLine);
        isDialogueRunning = false;
        vis.innerHTML = '<div class="overlay-gradient"></div>';
        vis.style.backgroundImage = `url('hub.jpg')`; 
        header.innerText = "éŠæˆ²é€²åº¦å·²æ‰¾åˆ°";
        feedback.innerHTML = '<div class="bubble bubble-mystery" style="margin-top:20px; text-align:center;">åµæ¢ï¼Œä½ ä¸Šæ¬¡çš„æœæŸ¥ç´€éŒ„è¢«ä¿å­˜äº†ã€‚<br>ä½ è¦å¾ä¸Šæ¬¡é›¢é–‹çš„åœ°æ–¹ç¹¼çºŒï¼Œé‚„æ˜¯é‡æ–°é–‹å§‹èª¿æŸ¥ï¼Ÿ</div>';
        feedback.scrollTop = feedback.scrollHeight;
        menu.innerHTML = '';
        
        document.getElementById('status-display').innerHTML = `â³ ç‹€æ…‹: <span id="game-status" style="color:#d4af37">ç­‰å¾…é¸æ“‡</span>`;

        const resumeBtn = document.createElement('button');
        resumeBtn.className = 'choice-btn';
        resumeBtn.style.fontWeight = 'bold';
        resumeBtn.innerText = "ğŸš€ ç¹¼çºŒé€²åº¦ (ä¸Šæ¬¡åœ¨ï¼š" + scenes[gameState.currentScene].title + ")";
        resumeBtn.onclick = () => {
            renderScene(gameState.currentScene, true);
            currentTrackId = 'bgm-main';
            tryInitMusic();
        };
        menu.appendChild(resumeBtn);

        const restartBtn = document.createElement('button');
        restartBtn.className = 'choice-btn replay-btn';
        restartBtn.innerText = "ğŸ”„ é‡æ–°é–‹å§‹éŠæˆ²";
        restartBtn.onclick = () => {
            localStorage.removeItem(STORAGE_KEY);
            gameState = {
                visited: new Set(),
                usedActions: new Set(),
                currentScene: '',
                sceneLogs: {}, 
                wrongAccusationCount: 0,
                lastAccused: null 
            };
            currentTrackId = 'bgm-main';
            tryInitMusic();
            
            renderScene('start_screen'); 
             runDialogueSequence([
                {t: "å¹³å®‰å¤œçš„é¢¨é›ªå‘¼å˜¯ï¼Œçœ¼å‰é€™æ£Ÿé€è‘—æš–å…‰çš„å°æœ¨å±‹ï¼Œæ˜¯æ­¤æ¬¡é è¶³çš„ç›®çš„åœ°ã€‚", type: 'system'},
                {t: "æ‚¨ä½é ­çœ‹äº†ä¸€çœ¼æ‰‹ä¸­é‚£å°ç¥ç§˜çš„é‚€è«‹å‡½ã€‚", type: 'system'},
                {t: "ç½²åæ˜¯é‚£ä½å‚³èªªä¸­çš„äººç‰©... ç‚ºä½•åœ¨æœ€å¿™ç¢Œçš„ä»Šæ™šï¼Œç‰¹åœ°é‚€è«‹ä¸€ä½åµæ¢å‰ä¾†ï¼Ÿ", type: 'system'},
                {t: "æ‡·è‘—äº›è¨±å¥½å¥‡ï¼Œæ‚¨è¸ä¸Šç©é›ªçš„éšæ¢¯ï¼Œæ‰‹æ­ä¸Šäº†åšé‡çš„æœ¨é–€ã€‚", type: 'system'}
            ]);
        };
        menu.appendChild(restartBtn);
    }
    
    window.onload = function() {
        if (loadGameState()) {
            showResumePrompt();
        } else {
            // åˆå§‹è¨­å®šç‚º Mainï¼Œä½†ç­‰å¾…äº’å‹•æ‰æ’­æ”¾
            currentTrackId = 'bgm-main';
            renderScene('start_screen');
            runDialogueSequence([
                {t: "å¹³å®‰å¤œçš„é¢¨é›ªå‘¼å˜¯ï¼Œçœ¼å‰é€™æ£Ÿé€è‘—æš–å…‰çš„å°æœ¨å±‹ï¼Œæ˜¯æ­¤æ¬¡é è¶³çš„ç›®çš„åœ°ã€‚", type: 'system'},
                {t: "æ‚¨ä½é ­çœ‹äº†ä¸€çœ¼æ‰‹ä¸­é‚£å°ç¥ç§˜çš„é‚€è«‹å‡½ã€‚", type: 'system'},
                {t: "ç½²åæ˜¯é‚£ä½å‚³èªªä¸­çš„äººç‰©... ç‚ºä½•åœ¨æœ€å¿™ç¢Œçš„ä»Šæ™šï¼Œç‰¹åœ°é‚€è«‹ä¸€ä½åµæ¢å‰ä¾†ï¼Ÿ", type: 'system'},
                {t: "æ‡·è‘—äº›è¨±å¥½å¥‡ï¼Œæ‚¨è¸ä¸Šç©é›ªçš„éšæ¢¯ï¼Œæ‰‹æ­ä¸Šäº†åšé‡çš„æœ¨é–€ã€‚", type: 'system'}
            ]);
        }
    };

    function playEndingFixGearSequence() {
        renderScene('ending_gear_fix');
        gameState.sceneLogs['ending_gear_fix'] = '';
        document.getElementById('feedback-area').innerHTML = '';
        runDialogueSequence([
            {t: "å¤§å®¶åˆåŠ›å°‡æ²ˆé‡çš„é‡‘è‰²é½’è¼ªæŠ¬èµ·ï¼Œæ¨å›äº†é˜æ¨“ä¸­å¿ƒçš„è»¸æ‰¿ä¸Šã€‚", type: 'system'},
            {t: "å¡å—’ï¼é½’è¼ªå®Œç¾å’¬åˆã€‚", type: 'system'},
            {t: "åŸæœ¬å‡æ»¯çš„é›ªèŠ±é–‹å§‹é£„è½ï¼Œç§’é‡ç™¼å‡ºäº†æ¸…è„†çš„èµ°å‹•è²ã€‚ä¸–ç•Œé–‹å§‹è§£å‡...", type: 'system'},
            {t: "å°±åœ¨é€™æ™‚ï¼Œç©ºæ°£ä¸­å‚³ä¾†äº†ä¸€é™£å®äº®æº«æš–çš„ç¬‘è²...", type: 'system'}
        ], () => {
            const menu = document.getElementById('interaction-bar');
            const btn = document.createElement('button');
            btn.className = 'choice-btn replay-btn'; 
            btn.innerText = "ğŸ‘‚ è½è½é‚£å€‹è²éŸ³";
            btn.onclick = () => handleAction('ending:santa_reveal'); 
            menu.appendChild(btn);
        });
    }
</script>
<div style="position: absolute; bottom: 10px; width: 100%; text-align: center; color: #666; font-size: 12px; pointer-events: none; z-index: 100;">
    Designed & Developed by jellyfishyjammy | Powered by Gemini AI
</div>
</body>
</html>
