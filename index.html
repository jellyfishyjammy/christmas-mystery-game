<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è–èª•å¤œçš„æ¶ˆå¤±é½’è¼ª</title>
    <style>
        /* --- è¦–è¦ºé¢¨æ ¼ --- */
        body {
            background-color: #050510;
            color: #e0e0e0;
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-image: radial-gradient(circle at center, #1a1a2e 0%, #000 100%);
        }

        #game-container {
            width: 1100px;
            height: 700px;
            background-color: rgba(30, 30, 35, 0.95);
            border: 1px solid #444;
            border-radius: 16px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            display: flex;
            position: relative;
            overflow: hidden;
        }

        #visual-panel {
            flex: 6;
            position: relative;
            background-color: #111;
            background-size: cover;
            background-position: center;
            border-right: 2px solid #222;
            transition: background-image 0.5s ease;
        }

        .overlay-gradient {
            position: absolute;
            bottom: 0; left: 0; right: 0; height: 120px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            pointer-events: none;
        }

        #narrative-panel {
            flex: 4;
            display: flex;
            flex-direction: column;
            background-color: #1e1e24;
        }

        #header-bar {
            padding: 20px;
            background: #15151a;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #scene-title { margin: 0; color: #d4af37; font-size: 20px; font-weight: bold; letter-spacing: 1px;
        }

        #feedback-area {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background-color: #25252b;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }
        #feedback-area::-webkit-scrollbar { width: 8px;
        }
        #feedback-area::-webkit-scrollbar-track { background: #222;
        }
        #feedback-area::-webkit-scrollbar-thumb { background: #444; border-radius: 4px;
        }

        .bubble {
            max-width: 90%;
            padding: 12px 18px;
            border-radius: 16px;
            font-size: 16px;
            line-height: 1.6;
            position: relative;
            animation: slideUp 0.5s ease-out;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            word-wrap: break-word;
        }

        .bubble-system {
            align-self: center;
            background: rgba(255, 255, 255, 0.05);
            color: #bbb;
            font-size: 15px;
            text-align: center;
            border: 1px dashed #444;
            width: 95%;
        }

        .bubble-char {
            align-self: flex-start;
            background: #33333a;
            color: #fff;
            border-bottom-left-radius: 2px;
            border-left: 4px solid #888;
        }
        .char-name { font-size: 12px; font-weight: bold; display: block; margin-bottom: 4px; color: #888;
        }

        .char-spark { border-left-color: #d40 !important;
        }
        .char-spark .char-name { color: #d40 !important;
        }

        .char-cookie { border-left-color: #da0 !important;
        }
        .char-cookie .char-name { color: #da0 !important;
        }

        .char-rudolph { border-left-color: #0a4 !important;
        }
        .char-rudolph .char-name { color: #0a4 !important;
        }

        .char-barnaby { border-left-color: #b4f !important;
        }
        .char-barnaby .char-name { color: #b4f !important;
        }

        .bubble-player {
            align-self: flex-end;
            background: #4a6fa5;
            color: #fff;
            border-bottom-right-radius: 2px;
        }
        
        .bubble-santa {
            background: #800;
            color: #fff;
            border: 2px solid #d40;
            align-self: center;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }

        .bubble-drama {
            background: #111;
            color: #ff3333;
            border: 1px solid #ff3333;
            align-self: center;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.3);
        }

        .bubble-mystery {
            align-self: center;
            background: #e0e0e0;
            color: #111;
            border: 2px solid #fff;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }

        @keyframes slideUp { from { opacity: 0;
            transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #interaction-bar {
            padding: 20px;
            background: #18181d;
            border-top: 1px solid #333;
            min-height: 160px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .choice-btn {
            background: linear-gradient(135deg, #2d2d35 0%, #25252b 100%);
            color: #e0e0e0;
            border: 1px solid #444;
            padding: 12px 15px;
            text-align: left;
            cursor: pointer;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }
        .choice-btn:hover {
            background: #383840;
            border-color: #d4af37;
            color: #d4af37;
            transform: translateX(5px);
        }
        
        .replay-btn {
            background: linear-gradient(135deg, #115511 0%, #004400 100%);
            border-color: #4ecdc4;
            justify-content: center;
            font-weight: bold;
        }

        .hotspot {
            position: absolute;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 215, 0, 0.5);
            color: #ffd700;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: transform 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .hotspot:hover {
            transform: scale(1.1);
            background: #ffd700;
            color: #000;
        }
        
        .profile-content { text-align: left;
            line-height: 1.8; }
        .hidden { display: none !important;
        }
    </style>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-71Z637FFS8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-71Z637FFS8');
</script>
</head>
<body>

<div id="game-container">
    <div id="visual-panel">
        <div class="overlay-gradient"></div>
    </div>

    <div id="narrative-panel">
        <div id="header-bar">
            <h2 id="scene-title">ç³»çµ±å•Ÿå‹•ä¸­...</h2>
            <div style="font-size:13px; color:#888;">ğŸ’ ç‹€æ…‹: <span id="game-status" style="color:#4ecdc4">æœæŸ¥ä¸­</span></div>
        </div>

        <div id="feedback-area"></div>
        <div id="interaction-bar"></div>
    </div>
</div>

<script>
  
    // --- 1. åˆå§‹åŒ– ---
    let audioCtx = null;
    function playSound(type) {
        if (!audioCtx) { try { audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        } catch(e){} }
        if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
    }
    // --- GA4 è¿½è¹¤å·¥å…· ---
function trackGameEvent(eventName, params = {}) {
    if (typeof gtag === 'function') {
        gtag('event', eventName, params);
        console.log(`ğŸ“¡ GA4 Event Sent: ${eventName}`, params); // é–‹ç™¼æ™‚å¯åœ¨ Console çœ‹åˆ°
    }
}

    // --- 2. éŠæˆ²è³‡æ–™ ---
    
    // --- éŠæˆ²ç‹€æ…‹åˆå§‹åŒ–èˆ‡æœ¬åœ°å­˜å„² ---
    const STORAGE_KEY = 'christmasMysteryGameSave';
    
    let gameState = {
        visited: new Set(),
        usedActions: new Set(),
        currentScene: '',
        sceneLogs: {}, 
        wrongAccusationCount: 0,
        lastAccused: null 
    };

    // å„²å­˜ç‹€æ…‹çš„å‡½æ•¸
    function saveGameState() {
        const stateToSave = {
            ...gameState,
            visited: Array.from(gameState.visited),
            usedActions: Array.from(gameState.usedActions),
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
    }

    // è¼‰å…¥ç‹€æ…‹çš„å‡½æ•¸
    function loadGameState() {
        const savedState = localStorage.getItem(STORAGE_KEY);
        if (savedState) {
            const parsedState = JSON.parse(savedState);
            gameState = {
                ...parsedState,
                visited: new Set(parsedState.visited),
                usedActions: new Set(parsedState.usedActions),
            };
            // ç”±æ–¼ sceneLogs ä¸­çš„ HTML å¯èƒ½åŒ…å«å‹•æ…‹ç”¢ç”Ÿçš„å…§å®¹ï¼Œæˆ‘å€‘åªéœ€è¦è¼‰å…¥ç•¶å‰å ´æ™¯çš„æ—¥èªŒ
            if (gameState.currentScene && gameState.sceneLogs[gameState.currentScene]) {
                return true; 
            }
        }
        return false;
    }
    // --- éŠæˆ²ç‹€æ…‹åˆå§‹åŒ–èˆ‡æœ¬åœ°å­˜å„² End ---


    const contentData = {
        profiles: {
            spark: `
                <div class="profile-content" style="border-left:4px solid #d40; padding-left:10px;">
                <b>ã€å²æ´¾å…‹ Sparkã€‘</b><br>
                ğŸ”§ <b>è·æ¥­ï¼š</b> ç²¾éˆç™¼æ˜å®¶<br>
                ğŸ“ <b>èº«é«˜ï¼š</b> 35 é¡†èºçµ²å¸½é«˜<br>
                ğŸ“‹ <b>ç‹€æ…‹ï¼š</b> æ»¿èº«æ©Ÿæ²¹ï¼Œæ­£åœ¨æ•²æ‰“æ©Ÿæ¢°ã€‚<br>
                </div>`,
            cookie: `
                <div class="profile-content" style="border-left:4px solid #da0; padding-left:10px;">
                <b>ã€åº«å¥‡ Cookieã€‘</b><br>
                ğŸª <b>è·æ¥­ï¼š</b> çš‡å®¶å¤§å»š<br>
                ğŸ“ <b>èº«é«˜ï¼š</b> 20 å±¤è–‘é¤…äººé«˜<br>
                ğŸ“‹ <b>ç‹€æ…‹ï¼š</b> åœ¨å»šæˆ¿ç„¦æ…®åœ°è¸±æ­¥ã€‚<br>
                </div>`,
            rudolph: `
                <div class="profile-content" style="border-left:4px solid #0a4; padding-left:10px;">
                <b>ã€é­¯é“å¤« Rudolphã€‘</b><br>
                ğŸ¦Œ <b>è·æ¥­ï¼š</b> é ˜èˆªé¦´é¹¿<br>
                ğŸ“ <b>èº«é«˜ï¼š</b> 1.5 æ£µè–èª•æ¨¹é«˜<br>
                ğŸ“‹ <b>ç‹€æ…‹ï¼š</b> èººåœ¨ç¨»è‰å †ä¸­ï¼Œè“‹è‘—åšæ¯¯å­ã€‚<br>
                </div>`
        },
        descriptions: {
            lab: "å¯¦é©—å®¤é›œäº‚ç„¡ç« ã€‚ä¸­å¤®æ”¾è‘—ä¸€å°å·¨å¤§çš„ç«ç®­å¼•æ“ï¼Œå‘¨åœæ•£è½è‘—ç„¡æ•¸èºçµ²å’Œé½’è¼ªã€‚",
            kitchen: "å»šæˆ¿æ¡Œä¸Šæ”¾è‘—ä¸€ç›¤å‰›è£é£¾å¥½çš„ç”œç”œåœˆï¼Œç©ºæ°£ä¸­å……æ»¿äº†ç”œè†©çš„é¦™æ°£ã€‚åº«å¥‡çœ‹èµ·ä¾†éå¸¸ç·Šå¼µã€‚",
            barn: "é¦¬å»„å¾ˆå®‰éœã€‚é­¯é“å¤«èººåœ¨ç¨»è‰å †è£¡ç¡è¦ºï¼Œå¶çˆ¾å‚³ä¾†å‘¼åš•è²ã€‚",
            tower_top: "ï¼ˆèª¿æŸ¥åœ°é»ï¼‰é˜æ¨“å¡”é ‚å¯’é¢¨å‡œå†½ã€‚åŸæœ¬æ”¾ç½®ã€Œæ°¸æ†é½’è¼ªã€çš„åŸºåº§ç¾åœ¨ç©ºç©ºå¦‚ä¹Ÿã€‚å››å‘¨é™¤äº†é›ªï¼Œæ²’æœ‰å…¶ä»–æ±è¥¿ã€‚"
        },
        clues: {
            spark: {
                engine: "ã€èª¿æŸ¥çµæœã€‘ç«ç®­å¼•æ“è™•æ–¼åŠæˆå“ç‹€æ…‹ã€‚ç«ç®­çš„æ ¸å¿ƒå‹•åŠ›å€è¢«ç•«äº†ç´…åœˆï¼Œæ—é‚Šçš„è¨­è¨ˆåœ–å¯«è‘—ï¼šã€Œç¾æœ‰é›»æ± å‹•åŠ›ä¸è¶³ï¼Œæ€¥éœ€ã€æ°¸æ†ã€ç´šåˆ¥çš„èƒ½æºæ›¿ä»£...ã€", // å‹•æ©Ÿ
                grappling_hook: "ã€èª¿æŸ¥çµæœã€‘ä¸€æŠŠæ”¹é€ éçš„ã€Œå¼·åŠ›ç£éµå›æ”¶çˆªã€ï¼Œé€™æ˜¯å¯ä»¥é ç«¯å¸å–é‡‘å±¬çš„è£ç½®ã€‚çˆªå­ä¸Šæ²¾æ»¿äº†åšåšä¸€å±¤ã€é‚„åœ¨æ»´è½çš„é»‘è‰²æ©Ÿæ²¹ã€‚" // æ‰‹æ®µ+æ’é™¤é—œéµ
            },
            cookie: {
                cookie_powder: "ã€èª¿æŸ¥çµæœã€‘æ¡Œä¸Šæœ‰ä¸€ç›¤ç‘æ»¿ç³–ç²‰çš„ç”œç”œåœˆã€‚ç³–ç²‰å‘ˆç¾ç‰¹æ®Šçš„è¢å…‰è—è‰²ã€‚é€™ç¨®ç²‰æœ«é¡†ç²’æ¥µç´°ï¼Œå¸¶æœ‰éœé›»ï¼Œæ¥µæ˜“å¸é™„åœ¨è¡£ç‰©æˆ–çš®è†šè¡¨é¢ã€‚",
                blueprint_sketch: "ã€èª¿æŸ¥çµæœã€‘ä¸€å¼µç•«åœ¨æ²¹æ¼¬é¤å·¾ç´™ä¸Šçš„è‰åœ–ã€‚æ¨™è¨»è‘—ï¼šã€Œå¿…é ˆåœ¨åˆå¤œå‰å®Œæˆæ›¿æ›ã€ã€ã€Œçµæ§‹è¦è¶³ä»¥ä»¥å‡äº‚çœŸã€ã€‚"
            },
            tower: {
                window_trace: "ã€èª¿æŸ¥çµæœã€‘20 å…¬å°ºé«˜çš„é€šé¢¨çª—å¤–ï¼Œçª—å°ç©è‘—åšåšçš„é›ªã€‚ä½ ä»”ç´°æª¢æŸ¥äº†é›ªé¢ï¼šå‘ˆç¾å®Œç¾çš„è‡ªç„¶å †ç©æ›²ç·šï¼Œæ²’æœ‰ä»»ä½•è…³å°ã€æ²’æœ‰æ¢¯å­é ‚ç«¯çš„å£“ç—•ï¼Œä¹Ÿæ²’æœ‰ç¹©ç´¢æ‹–æ›³çš„è»Œè·¡ã€‚",
                blue_powder_scene: "ã€èª¿æŸ¥çµæœã€‘åŸæœ¬æ”¾ç½®é½’è¼ªçš„åŸºåº§ç©ºç©ºå¦‚ä¹Ÿã€‚åŸºåº§è¡¨é¢éå¸¸ä¹¾æ·¨ï¼Œå®Œå…¨æ²’æœ‰æ²¹æ¼¬ï¼Œä½†æœ‰æ¡é›†åˆ°äº†è¢å…‰è—è‰²ç²‰æœ«ã€‚" // æ’é™¤å²æ´¾å…‹çš„é—œéµï¼šç¾å ´ç„¡æ²¹
            },
            rudolph: {
                donut_box: "ã€èª¿æŸ¥çµæœã€‘è§’è½çš„ç”œç”œåœˆç›’å­æ˜¯ç©ºçš„ã€‚é›–ç„¶é­¯é“å¤«é–‰è‘—çœ¼ï¼Œä½†åœ¨ä»–é¹¿è§’èˆ‡é¼»å°–ä¸Šï¼Œæ²¾è‘—äº›è¨±é¡¯çœ¼çš„è—è‰²ç²‰æœ«ã€‚",
                blanket_hidden: "ã€èª¿æŸ¥çµæœã€‘ä½ å°‡æ‰‹ä¼¸é€²æ¯¯å­ä¸‹æ–¹ã€‚é­¯é“å¤«çš„çš®æ¯›æ‘¸èµ·ä¾†æ¿•æ½¤ä¸”æº«åº¦å¾ˆé«˜ã€‚ç•¶ä»–åæ°£æ™‚ï¼Œé¼»å­”å™´å‡ºäº†æ˜é¡¯çš„ç™½éœ§ã€‚" // ç”Ÿç†è­‰æ“š
            }
        }
    };
    const scenes = {
        opening_frozen: {
            title: "11:59 çš„è–èª•æ‘",
            image: "invitation.jpg", 
            initText: "åœ¨ä¸€è™•æº«æš–çš„æœ¨å±‹ä¸­ï¼Œä½ ä½é ­çœ‹è‘—æ‰‹ä¸­çš„é‡‘ç®”é‚€è«‹å‡½ï¼šã€è‡´ å‚³å¥‡åµæ¢ï¼šä»Šæ™šæˆ–è¨±æœƒæœ‰å¤§äº‹ç™¼ç”Ÿï¼Œè«‹å‹™å¿…ä¾†è–èª•æ‘ä¸€æ•˜ã€‚â€”â€” è–èª•è€äººã€", 
            choices: [{ text: "ç­‰å¾…ç´„å®šæ™‚é–“", action: "play_prologue" }]
        },
        prologue: {
            title: "è–èª•è€äººçš„é æ„Ÿ",
            image: "barnaby_enter.jpg", 
            initText: "", 
            choices: [{ text: "æ¥éäººå“¡åå–®", action: "goto:files" }]
        },
        files: {
            title: "å«Œç–‘äººæª”æ¡ˆ",
            image: "files.jpg",
            initText: "é€™æ˜¯ç›®å‰å…¨è–èª•æ‘å”¯ä¸‰æ²’æœ‰è¢«ã€Œæ™‚é–“å‡çµã€çš„äººã€‚æ ¹æ“šå·´ç´æ¯”çš„åˆ¤æ–·ï¼ŒçŠ¯äººä¸€å®šå°±åœ¨å…¶ä¸­ã€‚",
            hotspots: [
                { label: "ğŸ“ æª”æ¡ˆï¼šå²æ´¾å…‹", top: "20%", left: "55%", action: "read:spark" },
                { label: "ğŸ“ æª”æ¡ˆï¼šåº«å¥‡", top: "60%", left: "20%", action: "read:cookie" },
                { label: "ğŸ“ æª”æ¡ˆï¼šé­¯é“å¤«", top: "60%", left: "70%", action: "read:rudolph" }
            ],
            choices: [{ text: "å‰å¾€ç¾å ´æœæŸ¥", action: "goto:hub" }]
        },
        hub: {
            title: "ä¸­å¤®å»£å ´",
            image: "hub.jpg",
            initText: "ã€æœæŸ¥ä»»å‹™å•Ÿå‹•ã€‘<br>ç›®å‰æ™‚é–“åœæ­¢åœ¨ 11:59ã€‚ä½ å¿…é ˆå®Œæˆä»¥ä¸‹ç›®æ¨™ï¼š<br><br>1. æ‰¾å‡ºç«Šå–ã€Œæ°¸æ†é½’è¼ªã€çš„çŠ¯äººã€‚<br>2. æŒæ¡çŠ¯æ¡ˆæ‰‹æ®µä»¥åŠèƒ½å¤ å®šç½ªçš„é—œéµç‰©ç†è­‰æ“šã€‚",
            hotspots: [
                { label: "ğŸš€ å¯¦é©—å®¤", top: "40%", left: "15%", action: "goto:lab" },
                { label: "ğŸª é»å¿ƒæˆ¿", top: "40%", left: "75%", action: "goto:kitchen" },
                { label: "ğŸ¦Œ é¦¬å»„", top: "70%", left: "50%", action: "goto:barn" },
                { label: "ğŸ° é˜æ¨“å¡”é ‚ (æ¡ˆç™¼åœ°)", top: "15%", left: "45%", action: "goto:tower_top" }
            ],
            choices: [
                { text: "ğŸ“‚ é‡çœ‹å«Œç–‘äººæª”æ¡ˆ", action: "goto:files" },
                { text: "âš–ï¸ æˆ‘å·²ç¶“çŸ¥é“çŠ¯äººæ˜¯èª°äº†ï¼", action: "pre_accuse" } 
            ]
        },
        tower_top: {
            title: "é˜æ¨“å¡”é ‚",
            image: "tower_top.jpg",
            initText: contentData.descriptions.tower_top,
            hotspots: [
                { label: "ğŸªŸ æª¢æŸ¥çª—æˆ¶", top: "30%", left: "50%", action: "check:window_trace" },
                { label: "âœ¨ æª¢æŸ¥åŸºåº§", top: "60%", left: "50%", action: "check:blue_powder_scene" }
            ],
            choices: [{ text: "è¿”å›å»£å ´", action: "goto:hub" }]
        },
        lab: {
            title: "å²æ´¾å…‹çš„å¯¦é©—å®¤",
            image: "lab.jpg",
            initText: contentData.descriptions.lab,
            hotspots: [
                { label: "âš™ï¸ æª¢æŸ¥å¼•æ“ç‹€æ³", top: "50%", left: "50%", action: "check:engine" },
                { label: "âœ‹ æª¢æŸ¥å¥‡æ€ªçš„å·¥å…·", top: "70%", left: "30%", action: "check:grappling_hook" }
            ],
            choices: [
                { text: "ğŸ—£ï¸ è³ªå•å²æ´¾å…‹", action: "goto:chat_spark" },
                { text: "ğŸ‘£ è¿”å›å»£å ´", action: "goto:hub" }
            ]
        },
        kitchen: {
            title: "åº«å¥‡çš„é»å¿ƒæˆ¿",
            image: "kitchen.jpg",
            initText: contentData.descriptions.kitchen,
            hotspots: [
                { label: "ğŸ© æª¢æŸ¥ç³–ç²‰", top: "60%", left: "50%", action: "check:cookie_powder" },
                { label: "ğŸ“ å¥‡æ€ªçš„è‰åœ–", top: "75%", left: "20%", action: "check:blueprint_sketch" }
            ],
            choices: [
                { text: "ğŸ—£ï¸ è³ªå•åº«å¥‡", action: "goto:chat_cookie" },
                { text: "ğŸ‘£ è¿”å›å»£å ´", action: "goto:hub" }
            ]
        },
        barn: {
            title: "é¦´é¹¿é¦¬å»„",
            image: "barn.jpg",
            initText: contentData.descriptions.barn,
            hotspots: [
                { label: "ğŸ‘„ è§€å¯Ÿé­¯é“å¤«", top: "50%", left: "60%", action: "check:donut_box" },
                { label: "ğŸ›Œ æª¢æŸ¥æ¯¯å­", top: "75%", left: "40%", action: "check:blanket_hidden" } 
            ],
            choices: [
                { text: "ğŸ—£ï¸ è³ªå•é­¯é“å¤«", action: "goto:chat_rudolph" },
                { text: "ğŸ‘£ è¿”å›å»£å ´", action: "goto:hub" }
            ]
        },
        
        // --- èŠå¤©å ´æ™¯ (å„ªåŒ–å°è©±èˆ‡å‹•æ©Ÿ) ---
        chat_spark: {
            title: "å°è©±ï¼šå²æ´¾å…‹",
            image: "face_spark.jpg",
            character: "å²æ´¾å…‹",
            choices: [
                { text: "ğŸ•’ ä½ ä»Šæ™šéƒ½åœ¨åšä»€éº¼ï¼Ÿ", action: "chat:spark_alibi" },
                { text: "ğŸ‘€ ä½ æœ‰æ³¨æ„åˆ°ä»€éº¼ç•°å¸¸å—ï¼Ÿ", action: "chat:spark_suspect" },
                { text: "ğŸ” é—œæ–¼é‚£å€‹å›æ”¶çˆª...", action: "chat:spark_tool" },
                { text: "ğŸ’¬ çµæŸå°è©±", action: "goto:lab" }
            ]
        },
        chat_cookie: {
            title: "å°è©±ï¼šåº«å¥‡",
            image: "face_cookie.jpg",
            character: "åº«å¥‡",
            choices: [
                { text: "ğŸ•’ ä½ ä»Šæ™šéƒ½åœ¨åšä»€éº¼ï¼Ÿ", action: "chat:cookie_alibi" },
                { text: "ğŸ‘€ ä½ æœ‰æ³¨æ„åˆ°ä»€éº¼ç•°å¸¸å—ï¼Ÿ", action: "chat:cookie_suspect" },
                { text: "ğŸ” é—œæ–¼é‚£å¼µè‰åœ–...", action: "chat:cookie_sketch" },
                { text: "ğŸ’¬ çµæŸå°è©±", action: "goto:kitchen" }
            ]
        },
        chat_rudolph: {
            title: "å°è©±ï¼šé­¯é“å¤«",
            image: "face_rudolph.jpg",
            character: "é­¯é“å¤«",
            choices: [
                { text: "ğŸ•’ ä½ ä»Šæ™šéƒ½åœ¨åšä»€éº¼ï¼Ÿ", action: "chat:rudolph_alibi" },
                { text: "ğŸ‘€ ä½ æœ‰æ³¨æ„åˆ°ä»€éº¼ç•°å¸¸å—ï¼Ÿ", action: "chat:rudolph_suspect" },
                { text: "ğŸ” é—œæ–¼ä½ èº«ä¸Šçš„ç²‰æœ«...", action: "chat:rudolph_powder" },
                { text: "ğŸ’¬ çµæŸå°è©±", action: "goto:barn" }
            ]
        },

        // --- çµå±€æµç¨‹ ---
        accuse_drama: {
            title: "æŒ‡èªæ™‚åˆ»",
            image: "accuse_drama.jpg",
            initText: "", 
            choices: [] 
        },
        accuse_denial: {
            title: "æŒ‡èªéŒ¯èª¤",
            image: "spark_denial_1.jpg", // é è¨­åœ–ç‰‡ï¼Œæœƒè¢«ç¨‹å¼ç¢¼å‹•æ…‹æ›¿æ›
            initText: "",
            choices: []
        },
        ending_confession: {
            title: "æ²‰é‡çš„çœŸç›¸",
            image: "rudolph_cry.jpg",
            initText: "", 
            choices: []
        },
        ending_teamwork: {
            title: "æˆ‘å€‘æ˜¯åœ˜éšŠ",
            image: "teamwork.jpg",
            initText: "", 
            choices: []
        },
        ending_gear_fix: {
            title: "é½’è¼ªæ­¸ä½",
            image: "fix_gear.jpg",
            initText: "",
            choices: []
        },
        ending_santa_reveal: {
            title: "ç†Ÿæ‚‰çš„ç¬‘è²",
            image: "santa_voice.jpg", 
            initText: "", 
            choices: [] 
        },
        ending_real_face: {
            title: "è–èª•å¿«æ¨‚",
            image: "santa_claus.jpg", 
            initText: "",
            choices: [
                { text: "ğŸ”„ å†ç©ä¸€æ¬¡", action: "reload" }
            ]
        }
    };
// --- 3. æ ¸å¿ƒé‚è¼¯ ---

    // --- æ–°å¢ï¼šé»æ“Šæ¨é€²æ§åˆ¶è®Šæ•¸ ---
    let dialogueQueue = [];
    let isDialogueRunning = false;
    let dialogueOnComplete = null;
    let dialogueTimer = null; 
    const clickArea = document.getElementById('game-container');
    // --- æ–°å¢ï¼šé»æ“Šæ¨é€²æ§åˆ¶è®Šæ•¸ End ---


    function renderScene(id, isResuming = false) {
        if (!scenes[id]) return;
        const scene = scenes[id];
        
        const isUpdate = (gameState.currentScene === id);
        
        // åªæœ‰åœ¨å ´æ™¯æ”¹è®Šæ™‚æ‰åŸ·è¡Œå¤§éƒ¨åˆ†çš„æ›´æ–°
        if (!isUpdate || isResuming) {
            gameState.currentScene = id; // æ›´æ–°ç•¶å‰å ´æ™¯
            trackGameEvent('scene_view', {
                scene_id: id,
                scene_title: scene.title
            });
            const vis = document.getElementById('visual-panel');
            const header = document.getElementById('scene-title');
            const feedback = document.getElementById('feedback-area');

            const statusContainer = document.getElementById('header-bar').querySelector('div:last-child');
            let statusText = "æœæŸ¥ä¸­";
            let statusIcon = "ğŸ’";
            if (['opening_frozen', 'prologue'].includes(id)) {
                statusText = "ç·Šæ€¥äº‹æ…‹";
                statusIcon = "ğŸš¨";
            } else if (id.startsWith('ending')) {
                statusText = "è–èª•å¥‡è¹Ÿ";
                statusIcon = "ğŸ„";
            } else if (id.startsWith('accuse')) {
                statusText = "æŒ‡èªå«ŒçŠ¯";
                statusIcon = "âš–ï¸";
            }
            
            statusContainer.innerHTML = `${statusIcon} ç‹€æ…‹: <span id="game-status" style="color:#4ecdc4">${statusText}</span>`;
            
            // è¼‰å…¥å ´æ™¯æ™‚ï¼Œå¦‚æœä¸æ˜¯åœ¨å°è©±ä¸­ï¼Œå‰‡æ¸…é™¤ç†±é»ä¸¦è¨­ç½®èƒŒæ™¯
            if (!isDialogueRunning) {
                vis.innerHTML = '<div class="overlay-gradient"></div>'; // æ¸…é™¤ç†±é»
                vis.style.backgroundImage = `url('${scene.image}')`;
            }

            header.innerText = scene.title;
            
            if (gameState.sceneLogs[id]) {
                // å¦‚æœæ˜¯å¾å­˜æª”è¼‰å…¥ï¼Œç›´æ¥æ¢å¾©å°è©±ç´€éŒ„
                feedback.innerHTML = gameState.sceneLogs[id];
            } else {
                feedback.innerHTML = '';
                if (scene.initText && !isResuming) {
                    addBubble(scene.initText, 'system');
                }
            }

            // åªæœ‰åœ¨éå°è©±/éçµå°¾å‹•ç•«æ™‚æ‰é¡¯ç¤ºç†±é»
            if (scene.hotspots && !isDialogueRunning && !id.startsWith('ending') && !id.startsWith('accuse')) {
                scene.hotspots.forEach(spot => {
                    const btn = document.createElement('div');
                    btn.className = 'hotspot';
                    btn.style.top = spot.top;
                    btn.style.left = spot.left;
                    btn.innerHTML = spot.label;
                    btn.onclick = () => handleAction(spot.action);
                    vis.appendChild(btn);
                });
            }
        }

        renderButtons(scene);
        if (['lab', 'kitchen', 'barn', 'tower_top'].includes(id)) gameState.visited.add(id);
        
        // åˆå§‹å ´æ™¯å°è©±è™•ç†
        if (id === 'opening_frozen' && !gameState.visited.has('opening') && !isResuming) {
            gameState.visited.add('opening');
            runDialogueSequence([
                {t: "ä½ ååœ¨æº«æš–çš„å£çˆå‰ï¼Œç‰†ä¸Šçš„æ›é˜æ­£æ»´ç­”ä½œéŸ¿ã€‚", type: 'system'},
                {t: "ç§’é‡æŒ‡å‘äº† 11:59 åˆ† 59 ç§’ã€‚", type: 'system'},
                {t: "åŸæœ¬è©²éŸ¿èµ·çš„æ•´é»é˜è²... å»æ²’æœ‰å‡ºç¾ã€‚", type: 'system'},
                {t: "ç«ç„°å‡å›ºåœ¨åŠç©ºä¸­ï¼Œçª—å¤–çš„é›ªèŠ±æ‡¸åœä¸å‹•ã€‚ä¸–ç•Œè¢«æŒ‰ä¸‹äº†æš«åœéµã€‚", type: 'system'}
            ]);
        }
        
        saveGameState(); // æ¯æ¬¡æ¸²æŸ“å ´æ™¯æˆ–ç‹€æ…‹æ›´æ–°éƒ½ä¿å­˜
    }

    function renderButtons(scene) {
        const menu = document.getElementById('interaction-bar');
        menu.innerHTML = '';
        if (scene.choices) {
            scene.choices.forEach(c => {
                if (c.action.startsWith('chat:') && gameState.usedActions.has(c.action)) return;
                
                if (c.action.startsWith('ending:team_') && gameState.usedActions.has(c.action)) return;

                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                
                if (c.action === 'reload' || c.action === 'ending:fix_gear') {
                    btn.className += ' replay-btn';
                }
                
                btn.innerHTML = c.text.startsWith('ğŸ”¹') || c.text.startsWith('âš™ï¸') || c.text.startsWith('ğŸ•’') || c.text.startsWith('ğŸ‘€') || c.text.startsWith('ğŸ”') ? c.text : "ğŸ”¹ " + c.text;
                btn.onclick = () => handleAction(c.action, c.text);
                menu.appendChild(btn);
            });
        }
    }

    function addBubble(text, type, name) {
        const feedback = document.getElementById('feedback-area');
        const div = document.createElement('div');
        
        if (type === 'system') {
            div.className = 'bubble bubble-system';
            div.innerHTML = text;
        } else if (type === 'char') {
            div.className = 'bubble bubble-char';
            if (name && name.includes('å²æ´¾å…‹')) div.classList.add('char-spark');
            else if (name && name.includes('åº«å¥‡')) div.classList.add('char-cookie');
            else if (name && name.includes('é­¯é“å¤«')) div.classList.add('char-rudolph');
            else if (name && name.includes('å·´ç´æ¯”')) div.classList.add('char-barnaby');
            
            div.innerHTML = `<span class="char-name">${name}</span>${text}`;
        } else if (type === 'player') {
            div.className = 'bubble bubble-player';
            div.innerHTML = text;
        } else if (type === 'santa') {
            div.className = 'bubble bubble-santa';
            div.innerHTML = text;
        } else if (type === 'drama') { 
            div.className = 'bubble bubble-drama';
            div.innerHTML = text;
        } else if (type === 'mystery') { 
            div.className = 'bubble bubble-mystery';
            div.innerHTML = text;
        }
        
        feedback.appendChild(div);
        if (!gameState.sceneLogs[gameState.currentScene]) {
            gameState.sceneLogs[gameState.currentScene] = '';
        }
        gameState.sceneLogs[gameState.currentScene] += div.outerHTML;

        requestAnimationFrame(() => { feedback.scrollTop = feedback.scrollHeight; });
        saveGameState(); // å°è©±æ°£æ³¡æ–°å¢å¾Œä¹Ÿä¿å­˜
    }

    // --- æ–°å¢ï¼šå°è©±æ¨é€²é‚è¼¯ ---
    function processNextDialogueLine() {
        // **[ç¢ºä¿æ¸…é™¤èˆŠçš„è¨ˆæ™‚å™¨ï¼Œç„¡è«–æ˜¯è‡ªå‹•é‚„æ˜¯é»æ“Šè§¸ç™¼ï¼Œç¢ºä¿æ¯æ¬¡åªè™•ç†ä¸€å€‹å…ƒä»¶]**
        clearTimeout(dialogueTimer); 

        if (dialogueQueue.length > 0) {
            const line = dialogueQueue.shift();
            addBubble(line.t, line.type || 'system', line.name);
            
            if (dialogueQueue.length > 0) {
                // å¦‚æœéšŠåˆ—ä¸­é‚„æœ‰å°è©±ï¼Œè¨­å®šæ–°çš„è‡ªå‹•æ’­æ”¾è¨ˆæ™‚å™¨
                dialogueTimer = setTimeout(processNextDialogueLine, 2200); // å»¶é²è‡ªå‹•æ’­æ”¾
            } else {
                // å°è©±çµæŸ
                isDialogueRunning = false;
                clickArea.removeEventListener('click', processNextDialogueLine);
                if (dialogueOnComplete) {
                    setTimeout(dialogueOnComplete, 800); // ç­‰å¾…æœ€å¾Œä¸€å€‹æ³¡æ³¡é¡¯ç¤ºå®Œç•¢
                } else {
                    renderScene(gameState.currentScene);
                }
            }
        }
    }

    function runDialogueSequence(lines, onComplete) {
        // æ¸…é™¤ä»»ä½•èˆŠçš„è‡ªå‹•æ’­æ”¾
        clearTimeout(dialogueTimer); 
        clickArea.removeEventListener('click', processNextDialogueLine);
        
        const menu = document.getElementById('interaction-bar');
        menu.innerHTML = ''; 
        
        dialogueQueue = [...lines];
        isDialogueRunning = true;
        dialogueOnComplete = onComplete;
        
        // å•Ÿç”¨é»æ“Šæ¨é€²
        clickArea.addEventListener('click', processNextDialogueLine);
        
        // ç«‹å³é¡¯ç¤ºç¬¬ä¸€å€‹å°è©±ä¸¦å•Ÿå‹•è‡ªå‹•æ’­æ”¾/é»æ“Šæ¨¡å¼
        processNextDialogueLine();
    }
    // --- æ–°å¢ï¼šå°è©±æ¨é€²é‚è¼¯ End ---

    function playPrologueSequence() {
        renderScene('prologue');
        gameState.sceneLogs['prologue'] = '';
        document.getElementById('feedback-area').innerHTML = '';

        runDialogueSequence([
            {t: "ï¼ˆç¢°ï¼æ¥å¾…å®¤çš„å¤§é–€è¢«æ’é–‹ï¼ï¼‰", type: "system"},
            {t: "è–èª•è€äººçš„åŠ©æ‰‹é•·â€”â€”å·´ç´æ¯”ï¼Œæ…Œå¼µåœ°è¡äº†é€²ä¾†ï¼Œå·®é»è¢«åœ°æ¯¯çµ†å€’ã€‚", type: "system"},
            {t: "è–èª•è€äººï¼å¤§äº‹ä¸å¥½äº†... å’¦ï¼Ÿä½ æ˜¯ï¼Ÿ", type: "char", name: "å·´ç´æ¯”"},
            {t: "å•Šï¼ä½ æ˜¯é‚£å°é‚€è«‹å‡½çš„... åµæ¢ï¼æ„Ÿè¬è€å¤©ä½ åœ¨é€™è£¡ï¼", type: "char", name: "å·´ç´æ¯”"}, 
            {t: "è–èª•è€äººä¸è¦‹äº†ï¼Œè€Œã€Œæ°¸æ†é½’è¼ªã€å‰›å‰›è¢«å·èµ°ï¼ç¾åœ¨æ™‚é–“å®Œå…¨åœæ­¢äº†ï¼", type: "char", name: "å·´ç´æ¯”"},
            {t: "æˆ‘å‰›æ‰è¶•å¿«ç¢ºèªäº†è–èª•æ‘çš„ç‹€æ³ï¼Œé™¤äº†æˆ‘ä¹‹å¤–ï¼Œåªæœ‰ä¸‰å€‹äººæ²’æœ‰è¢«æ™‚é–“å‡çµã€‚", type: "char", name: "å·´ç´æ¯”"},
            {t: "æˆ‘æŠŠä»–å€‘çš„è³‡æ–™éƒ½èª¿å‡ºä¾†äº†ï¼Œæ‹œè¨—ä½ ï¼Œä¸€å®šè¦æ‰¾å‡ºæ˜¯èª°åšçš„ï¼", type: "char", name: "å·´ç´æ¯”"}
        ], () => {
             const menu = document.getElementById('interaction-bar');
             const btn = document.createElement('button');
             btn.className = 'choice-btn';
             btn.innerText = "ğŸ”¹ æŸ¥çœ‹é€™ä¸‰äººçš„è³‡æ–™";
             btn.onclick = () => handleAction('goto:files');
             menu.appendChild(btn);
        });
    }

    function playAccusationSequence() {
        renderScene('accuse_drama');
        gameState.sceneLogs['accuse_drama'] = '';
        document.getElementById('feedback-area').innerHTML = '';

        runDialogueSequence([
            {t: "æ’é™¤ä¸å¯èƒ½çš„å› ç´ å¾Œï¼Œå‰©ä¸‹çš„...", type: "drama"},
            {t: "ç„¡è«–å¤šéº¼ä¸å¯æ€è­°ï¼Œé‚£å°±æ˜¯çœŸç›¸ï¼", type: "drama"},
            {t: "çŠ¯äººå°±åœ¨æˆ‘å€‘ä¹‹ä¸­ï¼", type: "drama"}
        ], () => {
             const menu = document.getElementById('interaction-bar');
             ['å²æ´¾å…‹', 'åº«å¥‡', 'é­¯é“å¤«'].forEach(name => {
                 const btn = document.createElement('button');
                 btn.className = 'choice-btn';
                 btn.style.justifyContent = 'center';
                 btn.style.fontWeight = 'bold';
                 btn.innerText = `ğŸ‘‰ æŒ‡èª ${name}`;
                 btn.onclick = () => handleAccusation(name);
                 menu.appendChild(btn);
             });
        });
    }

    function handleAccusation(name) {
        if (name === 'é­¯é“å¤«') {
            trackGameEvent('game_complete', {
            result: 'success',
            mistakes: gameState.wrongAccusationCount
        });
            renderScene('ending_confession');
            playConfessionSequence();
        } else {
            const isSamePerson = (gameState.lastAccused === name);
            gameState.lastAccused = name; 
            gameState.wrongAccusationCount++;
            trackGameEvent('accusation_failed', {
            accused_char: name,
            current_mistakes: gameState.wrongAccusationCount
        });
            
            if (isSamePerson) {
                playAngryDenialSequence(name);
            } else {
                if (gameState.wrongAccusationCount === 1) {
                    playDenialSequence(name);
                } else {
                    playInterruptedDenialSequence(name);
                }
            }
        }
    }

    function playAngryDenialSequence(name) {
        // è¨­å®šæ†¤æ€’/ç¬¬äºŒæ¬¡æŒ‡èªçš„åœ–ç‰‡
        if (name === 'å²æ´¾å…‹') scenes['accuse_denial'].image = 'spark_denial_2.jpg';
        else if (name === 'åº«å¥‡') scenes['accuse_denial'].image = 'cookie_denial_2.jpg';

        renderScene('accuse_denial');
        gameState.sceneLogs['accuse_denial'] = '';
        document.getElementById('feedback-area').innerHTML = '';

        let angryLines = [];
        if (name === 'å²æ´¾å…‹') {
            angryLines = [
                {t: "ä½ çš„é‚è¼¯é›»è·¯ç‡’å£äº†å—ï¼Ÿï¼", type: "char", name: "å²æ´¾å…‹"},
                {t: "å²æ´¾å…‹æ°£å¾—å…¨èº«ç™¼æŠ–ï¼Œç”¨åŠ›æŠŠæ‰³æ‰‹ç ¸åœ¨æ¡Œä¸Šï¼", type: "system"},
                {t: "æˆ‘èªªéä¸æ˜¯æˆ‘ï¼è¦æ˜¯å†èª£è³´æˆ‘ï¼Œæˆ‘å°±æŠŠä½ çš„é›ªæ©‡æ‹†æˆå»¢éµï¼", type: "char", name: "å²æ´¾å…‹"},
                {t: "ç§‘å­¸å®¶æ˜¯ä¸æœƒèªªè¬Šçš„ï¼æ°£æ­»æˆ‘äº†ï¼", type: "char", name: "å²æ´¾å…‹"}
            ];
        } else if (name === 'åº«å¥‡') {
            angryLines = [
                {t: "å™¢ï¼ä½ é€™å€‹æ²’ç¦®è²Œçš„åµæ¢ï¼", type: "char", name: "åº«å¥‡"},
                {t: "åº«å¥‡æ°£å¾—è‡‰æ¼²æˆäº†ç´…è‰²ï¼Œæ‰‹ä¸­çš„æ“ èŠ±è¢‹è¢«æå¾—è®Šå½¢ï¼Œç³–éœœå™´å¾—åˆ°è™•éƒ½æ˜¯ã€‚", type: "system"},
                {t: "æˆ‘èªªäº†æ²’æœ‰æ™‚é–“ï¼æˆ‘çš„è–‘é¤…å¿«çƒ¤ç„¦äº†ï¼ä½ é‚„è¦æµªè²»æˆ‘å¤šå°‘æ™‚é–“ï¼", type: "char", name: "åº«å¥‡"},
                {t: "å‡ºå»ï¼ä¸è¦å¦¨ç¤™æˆ‘çš„ç¥è–çƒ˜ç„™æ™‚åˆ»ï¼", type: "char", name: "åº«å¥‡"}
            ];
        } else {
            angryLines = [{t: "æˆ‘çœŸçš„ç”Ÿæ°£äº†ï¼ä¸æ˜¯æˆ‘ï¼", type: "char", name: name}];
        }
        
        runDialogueSequence(angryLines, () => {
            playAutoConfessionSequence();
        });
    }

    function playDenialSequence(name) {
        // è¨­å®šåˆæ¬¡æŒ‡èªçš„åœ–ç‰‡
        if (name === 'å²æ´¾å…‹') scenes['accuse_denial'].image = 'spark_denial_1.jpg';
        else if (name === 'åº«å¥‡') scenes['accuse_denial'].image = 'cookie_denial_1.jpg';

        renderScene('accuse_denial');
        gameState.sceneLogs['accuse_denial'] = '';
        document.getElementById('feedback-area').innerHTML = '';

        let denialLines = [];
        if (name === 'å²æ´¾å…‹') {
            denialLines = [
                {t: "ä»€éº¼ï¼Ÿæˆ‘ï¼Ÿ", type: "char", name: "å²æ´¾å…‹"},
                {t: "å²æ´¾å…‹çªå¤§äº†çœ¼ç›ï¼Œæ°£å¾—æ‰³æ‰‹éƒ½æ‰åœ¨åœ°ä¸Šã€‚", type: "system"},
                {t: "åµæ¢ï¼Œä½ çœ‹çœ‹æˆ‘çš„æ‰‹ï¼é€™æ©Ÿæ²¹è¦æ˜¯æ‘¸åˆ°é‚£å€‹é‡‘å…‰é–ƒé–ƒçš„é½’è¼ªï¼Œæ—©å°±ç•™ä¸‹æ‰‹å°äº†ï¼", type: "char", name: "å²æ´¾å…‹"}, 
                {t: "æˆ‘æ‰ä¸æœƒçŠ¯é€™ç¨®ä½ç´šéŒ¯èª¤ï¼", type: "char", name: "å²æ´¾å…‹"}
            ];
        } else if (name === 'åº«å¥‡') {
            denialLines = [
                {t: "å¤©å•Šï¼ä½ æ‡·ç–‘æˆ‘ï¼Ÿ", type: "char", name: "åº«å¥‡"},
                {t: "åº«å¥‡åš‡å¾—å·®é»æŠŠæ‰‹ä¸Šçš„æ“ èŠ±è¢‹æçˆ†ã€‚", type: "system"},
                {t: "æˆ‘åªæ˜¯ä¸€å€‹å»šå¸«ï¼æˆ‘è¦æ€éº¼çˆ¬ä¸Š 20 å…¬å°ºçš„é«˜å¡”ï¼Ÿ", type: "char", name: "åº«å¥‡"},
                {t: "è€Œä¸”æˆ‘çš„ç¥è–çš„ç³–éœœæ˜¯ç”¨ä¾†è£é£¾çš„ï¼Œä¸æ˜¯ç”¨ä¾†ç•¶è­‰ç‰©çš„ï¼", type: "char", name: "åº«å¥‡"}
            ];
        }

        runDialogueSequence(denialLines, () => {
            const menu = document.getElementById('interaction-bar');
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.innerText = "ğŸ”™ é‡æ–°æ€è€ƒ";
            btn.onclick = () => playAccusationSequence(); 
            menu.appendChild(btn);
        });
    }

    function playInterruptedDenialSequence(name) {
        // é›–ç„¶æ˜¯éŠæˆ²ä¸­çš„ç¬¬äºŒæ¬¡éŒ¯èª¤æŒ‡èªï¼Œä½†å°è©²è§’è‰²æ˜¯ç¬¬ä¸€æ¬¡ï¼Œæ‰€ä»¥ä½¿ç”¨ç¬¬ä¸€å¼µåœ–
        if (name === 'å²æ´¾å…‹') scenes['accuse_denial'].image = 'spark_denial_1.jpg';
        else if (name === 'åº«å¥‡') scenes['accuse_denial'].image = 'cookie_denial_1.jpg';

        renderScene('accuse_denial');
        gameState.sceneLogs['accuse_denial'] = '';
        document.getElementById('feedback-area').innerHTML = '';

        let startLines = [];
        if (name === 'å²æ´¾å…‹') {
            startLines = [{t: "ä½ æéŒ¯äº†ï¼æˆ‘æ ¹æœ¬æ²’åš...", type: "char", name: "å²æ´¾å…‹"}];
        } else if (name === 'åº«å¥‡') {
            startLines = [{t: "çœŸçš„ä¸æ˜¯æˆ‘ï¼æˆ‘å°è–èª•è€äººç™¼èª“...", type: "char", name: "åº«å¥‡"}];
        }
        
        runDialogueSequence(startLines, () => {
            playAutoConfessionSequence();
        });
    }

    function playAutoConfessionSequence() {
        document.getElementById('interaction-bar').innerHTML = '';
        // ä½¿ç”¨ runDialogueSequence è™•ç† "Wait!" çš„å°è©±ï¼Œç¢ºä¿å¯ä»¥é»æ“Šæ¨é€²
        runDialogueSequence([
            {t: "...ç­‰ç­‰ï¼", type: "mystery"}
        ], () => {
            // å°è©±çµæŸå¾Œï¼Œé¡¯ç¤ºæŒ‰éˆ•
            const menu = document.getElementById('interaction-bar');
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.innerText = "ğŸ‘€ æŸ¥çœ‹è²éŸ³ä¾†æº";
            btn.onclick = () => handleAction('ending:reveal_culprit'); 
            menu.appendChild(btn);
        });
    }

    function playConfessionSequence(skipIntro = false) {
        if (!skipIntro) {
            document.getElementById('feedback-area').innerHTML = '';
            gameState.sceneLogs['ending_confession'] = '';
        }

        let lines = [];
        if (!skipIntro) {
            lines = [
                {t: "è¢«æŒ‡èªå¾Œï¼Œé­¯é“å¤«åƒµåœ¨åŸåœ°ã€‚", type: "system"},
                {t: "ä»–ä¸‹æ„è­˜åœ°èˆ”äº†ä¸€ä¸‹å˜´è§’çš„è—è‰²ç³–ç²‰ï¼Œçœ¼ç›è£¡é–ƒçˆè‘—æ·šæ°´ã€‚", type: "system"},
                {t: "å°ä¸èµ·... æˆ‘çœŸçš„å¤ªç´¯äº†ã€‚", type: "char", name: "é­¯é“å¤«"}
            ];
        }

        lines.push(
            {t: "æ¯å¹´ç¦®ç‰©è¶Šä¾†è¶Šé‡... æˆ‘æ€•æˆ‘é£›ä¸å‹•äº†...", type: "char", name: "é­¯é“å¤«"},
            {t: "æˆ‘ä»¥ç‚ºåªè¦æ‹¿èµ°é½’è¼ªï¼Œæ™‚é–“åœä½ï¼Œæˆ‘å°±ä¸ç”¨é¢å°é€™ä¸€åˆ‡äº†ã€‚", type: "char", name: "é­¯é“å¤«"},
            {t: "é­¯é“å¤«é¡«æŠ–è‘—ä¸çŸ¥é“å¾ä½•è™•ï¼Œç·©ç·©æ¨å¾—é‚£æšé–ƒè€€è‘—é‡‘è‰²å…‰èŠ’çš„é½’è¼ªã€‚", type: "system"},
            {t: "ä»–ä½ä¸‹é ­ï¼Œå°‡é½’è¼ªæ»‘åˆ°äº†ä½ çš„è…³é‚Šã€‚", type: "system"}
        );
        runDialogueSequence(lines, () => {
            const menu = document.getElementById('interaction-bar');
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.innerText = "ğŸ”¹ é€™ä¸æ˜¯ä½ ä¸€å€‹äººçš„è²¬ä»»...";
            btn.onclick = () => handleAction('ending:teamwork');
            menu.appendChild(btn);
        });
    }

    function playEndingTeamworkSequence() {
        scenes['ending_teamwork'].choices = [
            { text: "ğŸ”¹ å²æ´¾å…‹æœ‰è©±è¦èªª", action: "ending:team_spark" }
        ];
        renderScene('ending_teamwork');
        gameState.sceneLogs['ending_teamwork'] = '';
        document.getElementById('feedback-area').innerHTML = '';
        
        runDialogueSequence([
            {t: "ä½ çœ‹è‘—é­¯é“å¤«å‚é ­å–ªæ°£çš„æ¨£å­ï¼Œæ­£æƒ³é–‹å£...", type: "system"}
        ], () => {
            renderButtons(scenes['ending_teamwork']);
        });
    }

    function handleAction(actionStr, btnText) {
        playSound('click');
        // é»æ“ŠæŒ‰éˆ•æ™‚ï¼Œæ¸…é™¤å°è©±æ¨é€²ç›£è½
        clickArea.removeEventListener('click', processNextDialogueLine);
        isDialogueRunning = false;
        
        // æ¸…é™¤è¨ˆæ™‚å™¨ï¼Œç¢ºä¿åœ¨åŸ·è¡Œæ–°å‹•ä½œæ™‚åœæ­¢ä»»ä½•å°è©±çš„è‡ªå‹•/åŠ é€Ÿæ¨é€²
        clearTimeout(dialogueTimer); 


        const [type, target] = actionStr.split(':');

        if (gameState.usedActions.has(actionStr)) {
            if (type === 'check' || type === 'read') {
                return;
            }
        }
        
        gameState.usedActions.add(actionStr);
        let parts = actionStr.split(':'); 
        trackGameEvent('player_choice', {
        action_type: parts[0],      // è¨˜éŒ„å‹•ä½œé¡å‹ (å¦‚ check, goto, chat)
        action_target: parts[1],    // è¨˜éŒ„ç›®æ¨™ (å¦‚ engine, lab)
        button_text: btnText || ''  // è¨˜éŒ„æŒ‰éˆ•ä¸Šçš„æ–‡å­—
        });
        saveGameState(); // è¡Œå‹•å¾Œä¿å­˜

        if (actionStr === 'play_prologue') {
            playPrologueSequence();
            return;
        }

        if (actionStr === 'reload') {
            localStorage.removeItem(STORAGE_KEY); // é‡ç©æ™‚æ¸…é™¤å­˜æª”
            location.reload();
            return;
        }

        if (type === 'goto') {
            renderScene(target);
        } 
        else if (type === 'read') {
            runDialogueSequence([{t: contentData.profiles[target], type: 'system'}]);
        } 
        else if (type === 'check') {
            let text = "";
            if(contentData.clues[target]) {
                text = contentData.clues[target];
            } else {
                if (target === 'engine') text = contentData.clues.spark.engine;
                else if (target === 'grappling_hook') text = contentData.clues.spark.grappling_hook;
                else if (target === 'cookie_powder') text = contentData.clues.cookie.cookie_powder;
                else if (target === 'blueprint_sketch') text = contentData.clues.cookie.blueprint_sketch;
                else if (target === 'window_trace') text = contentData.clues.tower.window_trace;
                else if (target === 'blue_powder_scene') text = contentData.clues.tower.blue_powder_scene;
                else if (target === 'donut_box') text = contentData.clues.rudolph.donut_box;
                else if (target === 'blanket_hidden') text = contentData.clues.rudolph.blanket_hidden;
            }
            runDialogueSequence([{t: text, type: 'system'}]);
        } 
        else if (type === 'chat') {
            // å°‡ç©å®¶çš„æå•ä¹Ÿç´å…¥ runDialogueSequence çš„è‡ªå‹•æ¨é€²åºåˆ—
            let chatLines = [];
            
            // 1. åŠ å…¥ç©å®¶çš„æå•
            if(btnText) {
                chatLines.push({t: btnText, type: 'player'});
            }
            
            // 2. æº–å‚™ NPC çš„å›æ‡‰
            
            // å²æ´¾å…‹ (Red Herring Mode)
            if (target === 'spark_alibi') {
                chatLines.push(
                    {t: "æˆ‘åœ¨åšä»€éº¼ï¼Ÿæˆ‘åœ¨è©¦åœ–æ‹¯æ•‘è–èª•ç¯€çš„ç‰©æµç³»çµ±ï¼", type: 'char', name: 'å²æ´¾å…‹'},
                    {t: "é€™å°å¼•æ“éœ€è¦å¼·å¤§çš„å‹•åŠ›æºã€‚æˆ‘æ•´æ™šéƒ½åœ¨è¨ˆç®—æ•¸æ“šï¼Œæƒ³è¾¦æ³•æ‰¾æ›¿ä»£èƒ½æº...", type: 'char', name: 'å²æ´¾å…‹'},
                    {t: "ä½†æˆ‘ç™¼èª“ï¼Œæˆ‘æ•´æ™šéƒ½åœ¨å¯¦é©—å®¤è£¡ï¼Œå“ªå…’ä¹Ÿæ²’å»ã€‚", type: 'char', name: 'å²æ´¾å…‹'}
                );
            } else if (target === 'spark_suspect') {
                chatLines.push(
                    {t: "å¦‚æœä½ å•æˆ‘ï¼Œæˆ‘é‚„æ˜¯è¦ºå¾—é«˜è™•æœ‰å•é¡Œã€‚", type: 'char', name: 'å²æ´¾å…‹'},
                    {t: "æˆ‘åŠå¤œåäºŒé»å‰æœ‰çŸ­æš«å‡ºå»ä¸€ä¸‹ã€‚", type: 'char', name: 'å²æ´¾å…‹'},
                    {t: "é‚£æ™‚é›–ç„¶åœ°é¢ç„¡é¢¨ï¼Œä½†æˆ‘çœ‹åˆ°å¡”é ‚çš„é¢¨å‘æ¨™åœ¨ç˜‹ç‹‚æ—‹è½‰ã€‚é‚£è£¡è‚¯å®šæœ‰æ°£æµæ“¾å‹•ã€‚", type: 'char', name: 'å²æ´¾å…‹'} 
                );
            } else if (target === 'spark_tool') {
                chatLines.push(
                    {t: "ï¼ˆå²æ´¾å…‹çœ¼ç¥æ¸¸ç§»äº†ä¸€ä¸‹ï¼‰é‚£å€‹ï¼Ÿé‚£åªæ˜¯å€‹... å·¥æ¥­ç”¨çš„å¤¾å¨ƒå¨ƒæ©Ÿã€‚", type: 'char', name: 'å²æ´¾å…‹'},
                    {t: "é€™æ˜¯æˆ‘çš„å‰å¤§ç™¼æ˜ï¼åªè¦åœ¨ 20 å…¬å°ºå…§ï¼Œæˆ‘å°±èƒ½å¸å–ä»»ä½•é‡‘å±¬ï¼", type: 'char', name: 'å²æ´¾å…‹'},
                    {t: "åˆ¥ç¢°å®ƒï¼å¾ˆç²¾å¯†çš„... è€Œä¸”ä¸Šé¢éƒ½æ˜¯æ²¹ã€‚", type: 'char', name: 'å²æ´¾å…‹'} // æ•…æ„ä¸èªªä»–æ²’ç”¨éï¼Œåªèªªåˆ¥ç¢°ï¼Œè®“ç©å®¶è‡ªå·±ç™¼ç¾æ²¹
                );
            }
            
            // åº«å¥‡
            else if (target === 'cookie_alibi') {
                chatLines.push(
                    {t: "æˆ‘åœ¨ 11:45 å®Œæˆäº†è—è‰²æ˜Ÿå¡µç”œç”œåœˆçš„è£é£¾ã€‚", type: 'char', name: 'åº«å¥‡'},
                    {t: "ä¹‹å¾Œæˆ‘å¸¶è‘—ç›’å­å»äº†é¦¬å»„ï¼ŒæŠŠç”œç”œåœˆæ”¾åœ¨é­¯é“å¤«çš„é£Ÿæ§½æ—é‚Šã€‚é‚£æ™‚å€™ä»–åœ¨ç¡è¦ºï¼Œæˆ‘å°±æ²’å«é†’ä»–ï¼Œç›´æ¥é›¢é–‹äº†ã€‚", type: 'char', name: 'åº«å¥‡'}
                );
            } else if (target === 'cookie_suspect') {
                chatLines.push(
                    {t: "æˆ‘è¦ºå¾—æ˜¯å²æ´¾å…‹ã€‚", type: 'char', name: 'åº«å¥‡'},
                    {t: "ä»–ä¸€ç›´æƒ³æŠŠé‚£å€‹é½’è¼ªæ‹†ä¸‹ä¾†ç ”ç©¶ã€‚è€Œä¸”ä»–æ‰‹é‚£éº¼é«’ï¼Œå¤§æ¦‚é€£ä½œæ¡ˆç¾å ´éƒ½æœƒå¼„é«’å§ï¼Ÿ", type: 'char', name: 'åº«å¥‡'}
                );
            } else if (target === 'cookie_sketch') {
                chatLines.push(
                    {t: "é€™å¼µåœ–ï¼Ÿé€™æ˜¯æˆ‘ç‚ºäº†è–èª•æ´¾å°æº–å‚™çš„ã€Œé©šå–œå¤§è›‹ç³•ã€è¨­è¨ˆåœ–ï¼", type: 'char', name: 'åº«å¥‡'},
                    {t: "æˆ‘æ‰“ç®—çƒ¤ä¸€å€‹è·Ÿé˜æ¨“é½’è¼ªä¸€æ¨¡ä¸€æ¨£çš„è–‘é¤…ï¼Œæ”¾åœ¨å¡”é ‚è£é£¾ã€‚", type: 'char', name: 'åº«å¥‡'},
                    {t: "ã€Œä»¥å‡äº‚çœŸã€æ˜¯æŒ‡ç³–éœœçš„å…‰æ¾¤æ„Ÿå•¦ï¼ä½ å€‘åµæ¢éƒ½é€™éº¼æ•æ„Ÿå—ï¼Ÿ", type: 'char', name: 'åº«å¥‡'}
                );
            }
            
            // é­¯é“å¤« (ç–²æ†Š & é˜²è¡›)
            else if (target === 'rudolph_alibi') {
                chatLines.push(
                    {t: "ï¼ˆé­¯é“å¤«æ‰“äº†ä¸€å€‹é•·é•·çš„å“ˆæ¬ ï¼‰", type: 'system'},
                    {t: "å¾æ™šä¸Šåé»ç†„ç‡ˆå¾Œï¼Œæˆ‘å°±ä¸€ç›´åœ¨é€™è£¡ç¡è¦ºã€‚", type: 'char', name: 'é­¯é“å¤«'},
                    {t: "è–èª•ç¯€çš„é£›è¡Œä»»å‹™å¾ˆé‡è¦ï¼Œæˆ‘å¿…é ˆå„²å‚™é«”åŠ›... æ‹œè¨—ï¼Œè®“æˆ‘å¤šç¡ä¸€æœƒå§ã€‚", type: 'char', name: 'é­¯é“å¤«'} // è¬Šè¨€ï¼šå…¶å¯¦å‰›å›ä¾†
                );
            } else if (target === 'rudolph_suspect') {
                chatLines.push(
                    {t: "æˆ‘ç¡å¾—å¾ˆæ­»ï¼Œä»€éº¼éƒ½æ²’è½åˆ°ï¼Œä¹Ÿæ²’çœ‹åˆ°ã€‚", type: 'char', name: 'é­¯é“å¤«'},
                    {t: "ä¹Ÿè¨±ä½ å¯ä»¥å»å•å•é‚£äº›é‚„é†’è‘—çš„äººï¼Ÿä¸è¦ç‚ºé›£æˆ‘é€™éš»æƒ³ç¡è¦ºçš„é¦´é¹¿äº†ã€‚", type: 'char', name: 'é­¯é“å¤«'} // è©¦åœ–ç½®èº«äº‹å¤–
                );
            } else if (target === 'rudolph_powder') {
                chatLines.push(
                    {t: "ç²‰æœ«ï¼Ÿ...å™¢ã€‚", type: 'char', name: 'é­¯é“å¤«'},
                    {t: "å¤§æ¦‚æ˜¯åº«å¥‡é€é»å¿ƒä¾†çš„æ™‚å€™å¼„å¾—åˆ°è™•éƒ½æ˜¯å§ã€‚ä½ çŸ¥é“ä»–é‚£å€‹äººï¼Œå‹•ä½œç¸½æ˜¯å¾ˆå¤§ã€‚", type: 'char', name: 'é­¯é“å¤«'},
                    {t: "é€™æ‡‰è©²ä¸çŠ¯æ³•å§ï¼Ÿæ²¾åˆ°ä¸€é»ç³–ç²‰ï¼Ÿ", type: 'char', name: 'é­¯é“å¤«'} // é¿é‡å°±è¼•
                );
            } else {
                chatLines.push({t: "...", type: 'char', name: 'NPC'});
            }

            // 3. åŸ·è¡ŒåŒ…å«ç©å®¶æå•å’Œ NPC å›æ‡‰çš„å®Œæ•´åºåˆ—
            runDialogueSequence(chatLines);
        }
        else if (type === 'pre_accuse') {
            if(!confirm("âš ï¸ è­¦å‘Šï¼šæŒ‡èªæ©Ÿæœƒåƒ…æœ‰å…©æ¬¡ã€‚\nè«‹ç¢ºèªä½ å·²æŒæ¡ã€ŒçŠ¯æ¡ˆæ‰‹æ®µã€èˆ‡ã€Œé—œéµè­‰ç‰©ã€çš„é€£çµã€‚\n\nç¢ºå®šè¦ç¾åœ¨æŒ‡èªå—ï¼Ÿ")) return;
            playAccusationSequence(); 
        }
        else if (type === 'ending') {
            if (target === 'teamwork') {
                playEndingTeamworkSequence();
            } 
            else if (target === 'reveal_culprit') {
                renderScene('ending_confession');
                gameState.sceneLogs['ending_confession'] = '';
                document.getElementById('feedback-area').innerHTML = '';
                
                runDialogueSequence([
                    {t: "åˆ¥å†çŒœäº†ï¼", type: "char", name: "é­¯é“å¤«"},
                    {t: "é­¯é“å¤«çªç„¶ç«™äº†å‡ºä¾†ï¼Œæ‰“æ–·äº†å°è©±ã€‚", type: "system"},
                    {t: "ä¸æ˜¯ä»–å€‘... æ˜¯æˆ‘ã€‚æ˜¯æˆ‘åšçš„ã€‚", type: "char", name: "é­¯é“å¤«"},
                    {t: "æˆ‘ä¸å¸Œæœ›å› ç‚ºæˆ‘çš„è‡ªç§ï¼Œè®“å…¶ä»–äººè¢«èª¤æœƒã€‚", type: "char", name: "é­¯é“å¤«"},
                    {t: "å°ä¸èµ·... æˆ‘çœŸçš„å¾ˆæŠ±æ­‰ã€‚", type: "char", name: "é­¯é“å¤«"}
                ], () => {
                    playConfessionSequence(true); 
                });
            }
            else if (target === 'team_spark') {
                runDialogueSequence([
                    {t: "å²æ´¾å…‹è¡ä¸Šå‰ï¼Œç”¨åŠ›æ‹äº†æ‹é­¯é“å¤«çš„èƒŒã€‚", type: "system"},
                    {t: "å‚»ç“œï¼ä½ ä»¥ç‚ºæˆ‘åšé‚£äº›ç«ç®­æ˜¯ç‚ºäº†ä»€éº¼ï¼Ÿ", type: "char", name: "å²æ´¾å…‹"},
                    {t: "å°±æ˜¯ç‚ºäº†å¹«ä½ åœ¨èµ·é£›æ™‚æ¨é€²å•Šï¼ä»Šå¹´æˆ‘å€‘å¯ä»¥ç”¨è¼”åŠ©å¼•æ“ä¾†å¹«ä½ é£›è¡Œï¼", type: "char", name: "å²æ´¾å…‹"}
                ], () => {
                    scenes['ending_teamwork'].choices = [{ text: "ğŸ”¹ åº«å¥‡æ‹¿å‡ºäº†æ±è¥¿", action: "ending:team_cookie" }];
                    renderButtons(scenes['ending_teamwork']);
                });
            } else if (target === 'team_cookie') {
                runDialogueSequence([
                    {t: "åº«å¥‡å¾å£è¢‹æå‡ºä¸€å¡Šç†±é¨°é¨°çš„è–‘é¤…ï¼Œéäº†éå»ã€‚", type: "system"},
                    {t: "é‚„æœ‰é€™å€‹ï¼é€™è£¡é¢åŠ äº†é›™å€çš„å¿«æ¨‚é­”æ³•ç³–éœœã€‚", type: "char", name: "åº«å¥‡"},
                    {t: "åƒä¸‹å»ï¼Œä½ æœƒè¦ºå¾—è¼•é£„é£„çš„ï¼", type: "char", name: "åº«å¥‡"}
                ], () => {
                    scenes['ending_teamwork'].choices = [{ text: "ğŸ”¹ å·´ç´æ¯”çš„ç¸½çµ", action: "ending:team_barnaby" }];
                    renderButtons(scenes['ending_teamwork']);
                });
            } else if (target === 'team_barnaby') {
                runDialogueSequence([
                    {t: "å·´ç´æ¯”èµ°åˆ°é­¯é“å¤«é¢å‰ã€‚", type: "system"},
                    {t: "åµæ¢æ‰¾å‡ºäº†çœŸç›¸ï¼Œä½†è§£æ±ºå•é¡Œéœ€è¦æˆ‘å€‘å¤§å®¶ã€‚", type: "char", name: "å·´ç´æ¯”"}, 
                    {t: "é­¯é“å¤«ï¼Œä½ æ˜¯æˆ‘å€‘çš„é ˜èˆªå“¡ï¼Œæ²’æœ‰ä½ ï¼Œæˆ‘å€‘èª°ä¹Ÿå»ä¸äº†ã€‚", type: "char", name: "å·´ç´æ¯”"},
                    {t: "é­¯é“å¤«æ“¦ä¹¾çœ¼æ·šï¼Œç´…é¼»å­å¾®å¾®ç™¼äº®ã€‚", type: "system"},
                    {t: "è¬è¬... è¬è¬ä½ å€‘ã€‚é‚£æˆ‘å€‘... å‡ºç™¼å§ï¼Ÿ", type: "char", name: "é­¯é“å¤«"}
                ], () => {
                    scenes['ending_teamwork'].choices = [{ text: "âš™ï¸ ä¿®å¾©æ™‚é–“ï¼Œå•Ÿå‹•è–èª•ç¯€ï¼", action: "ending:fix_gear" }];
                    renderButtons(scenes['ending_teamwork']);
                });
            }
            else if (target === 'fix_gear') {
                playEndingFixGearSequence();
            } else if (target === 'santa_reveal') {
                renderScene('ending_santa_reveal');
                gameState.sceneLogs['ending_santa_reveal'] = '';
                document.getElementById('feedback-area').innerHTML = '';

                runDialogueSequence([
                    {t: "Ho Ho Hoï¼åšå¾—å¥½å•Šï¼Œå„ä½ï¼", type: 'santa'}, // å…ˆå‡ºè²éŸ³
                    {t: "ï¼ˆå¤§å®¶é©šè¨åœ°æŠ¬èµ·é ­ï¼Œå°‹æ‰¾è²éŸ³çš„ä¾†æº...ï¼‰", type: 'system'}
                ], () => {
                     const menu = document.getElementById('interaction-bar');
                     const btn = document.createElement('button');
                     btn.className = 'choice-btn';
                     btn.innerText = "ğŸ”¹ è½‰èº«çœ‹æ˜¯èª°ï¼Ÿ";
                     btn.onclick = () => handleAction('ending:show_face'); // å†çœ‹è‡‰
                     menu.appendChild(btn);
                });
            } else if (target === 'show_face') {
                renderScene('ending_real_face');
                runDialogueSequence([
                    {t: "æ˜¯è–èª•è€äººï¼", type: 'system'},
                    {t: "åµæ¢ï¼Œé‚„è¨˜å¾—é‚£å°é‚€è«‹å‡½å—ï¼Ÿ", type: 'santa'},
                    {t: "æˆ‘å¯«è‘—ã€Œä»Šæ™šæœƒæœ‰å¤§äº‹ç™¼ç”Ÿã€ã€‚æˆ‘æŒ‡çš„ä¸æ˜¯å¤±ç«Šï¼Œè€Œæ˜¯ä½ å€‘çš„ã€Œåœ˜åœ“ã€ã€‚", type: 'santa'},
                    {t: "é­¯é“å¤«ï¼Œä¸éœ€è¦ç¨è‡ªæ‰¿æ“”ä¸€åˆ‡ã€‚çœŸæ­£çš„è–èª•é­”æ³•ï¼Œå¾ä¾†ä¸æ˜¯ç¦®ç‰©ï¼Œè€Œæ˜¯å½¼æ­¤æ‰¶æŒçš„å¿ƒã€‚", type: 'santa'},
                    {t: "Merry Christmasï¼å­©å­å€‘é‚„åœ¨ç­‰è‘—æˆ‘å€‘å‘¢ï¼Œä¸Šå·¥å›‰ï¼", type: 'santa'}
                ], () => {
                    const menu = document.getElementById('interaction-bar');
                    const btn = document.createElement('button');
                    btn.className = 'choice-btn replay-btn';
                    btn.innerText = "ğŸ”„ å†ç©ä¸€æ¬¡";
                    btn.onclick = () => location.reload();
                    menu.appendChild(btn);
                });
            }
        }
    }

    // --- æ–°å¢ï¼šé¡¯ç¤ºæ¢å¾©é€²åº¦é¸é … ---
    function showResumePrompt() {
        const vis = document.getElementById('visual-panel');
        const header = document.getElementById('scene-title');
        const feedback = document.getElementById('feedback-area');
        const menu = document.getElementById('interaction-bar');
        
        // ç¢ºä¿åœæ­¢ä»»ä½•è‡ªå‹•æ¨é€²
        clearTimeout(dialogueTimer); 
        clickArea.removeEventListener('click', processNextDialogueLine);
        isDialogueRunning = false;

        // æ¸…ç†ä¸¦è¨­ç½®ä»‹é¢
        vis.innerHTML = '<div class="overlay-gradient"></div>';
        vis.style.backgroundImage = `url('hub.jpg')`; // ä¸­æ€§èƒŒæ™¯
        header.innerText = "éŠæˆ²é€²åº¦å·²æ‰¾åˆ°";
        feedback.innerHTML = '<div class="bubble bubble-mystery" style="margin-top:20px; text-align:center;">åµæ¢ï¼Œä½ ä¸Šæ¬¡çš„æœæŸ¥ç´€éŒ„è¢«ä¿å­˜äº†ã€‚<br>ä½ è¦å¾ä¸Šæ¬¡é›¢é–‹çš„åœ°æ–¹ç¹¼çºŒï¼Œé‚„æ˜¯é‡æ–°é–‹å§‹èª¿æŸ¥ï¼Ÿ</div>';
        feedback.scrollTop = feedback.scrollHeight;
        menu.innerHTML = '';
        
        // æ›´æ–°ç‹€æ…‹åˆ—
        document.getElementById('header-bar').querySelector('div:last-child').innerHTML = `â³ ç‹€æ…‹: <span id="game-status" style="color:#d4af37">ç­‰å¾…é¸æ“‡</span>`;

        // ç¹¼çºŒæŒ‰éˆ•
        const resumeBtn = document.createElement('button');
        resumeBtn.className = 'choice-btn';
        resumeBtn.style.fontWeight = 'bold';
        resumeBtn.innerText = "ğŸš€ ç¹¼çºŒé€²åº¦ (ä¸Šæ¬¡åœ¨ï¼š" + scenes[gameState.currentScene].title + ")";
        resumeBtn.onclick = () => {
            // æ¢å¾©ä¸Šæ¬¡çš„å ´æ™¯
            renderScene(gameState.currentScene, true);
        };
        menu.appendChild(resumeBtn);

        // é‡æ–°é–‹å§‹æŒ‰éˆ•
        const restartBtn = document.createElement('button');
        restartBtn.className = 'choice-btn replay-btn';
        restartBtn.innerText = "ğŸ”„ é‡æ–°é–‹å§‹éŠæˆ²";
        restartBtn.onclick = () => {
            localStorage.removeItem(STORAGE_KEY); // æ¸…é™¤å­˜æª”
            // é‡æ–°åˆå§‹åŒ– gameState
            gameState = {
                visited: new Set(),
                usedActions: new Set(),
                currentScene: '',
                sceneLogs: {}, 
                wrongAccusationCount: 0,
                lastAccused: null 
            };
            renderScene('opening_frozen'); // è¼‰å…¥åˆå§‹å ´æ™¯
        };
        menu.appendChild(restartBtn);
    }
    // --- 4. å•Ÿå‹•éŠæˆ² ---
    window.onload = function() {
        if (loadGameState()) {
            // å¾å­˜æª”æ¢å¾©
            showResumePrompt(); // **[ä¿®æ”¹ï¼šå¦‚æœæˆåŠŸè¼‰å…¥å­˜æª”ï¼Œé¡¯ç¤ºé¸æ“‡é¸é …]**
        } else {
            // é¦–æ¬¡å•Ÿå‹•
            renderScene('opening_frozen');
        }
    };

    function playEndingFixGearSequence() {
        renderScene('ending_gear_fix');
        gameState.sceneLogs['ending_gear_fix'] = '';
        document.getElementById('feedback-area').innerHTML = '';
        runDialogueSequence([
            {t: "å¤§å®¶åˆåŠ›å°‡æ²ˆé‡çš„é‡‘è‰²é½’è¼ªæŠ¬èµ·ï¼Œæ¨å›äº†é˜æ¨“ä¸­å¿ƒçš„è»¸æ‰¿ä¸Šã€‚", type: 'system'},
            {t: "å¡å—’ï¼é½’è¼ªå®Œç¾å’¬åˆã€‚", type: 'system'},
            {t: "åŸæœ¬å‡æ»¯çš„é›ªèŠ±é–‹å§‹é£„è½ï¼Œç§’é‡ç™¼å‡ºäº†æ¸…è„†çš„èµ°å‹•è²ã€‚ä¸–ç•Œé–‹å§‹è§£å‡...", type: 'system'},
            {t: "å°±åœ¨é€™æ™‚ï¼Œç©ºæ°£ä¸­å‚³ä¾†äº†ä¸€é™£å®äº®æº«æš–çš„ç¬‘è²...", type: 'system'}
        ], () => {
            const menu = document.getElementById('interaction-bar');
            const btn = document.createElement('button');
            btn.className = 'choice-btn replay-btn'; 
            btn.innerText = "ğŸ‘‚ è½è½é‚£å€‹è²éŸ³";
            btn.onclick = () => handleAction('ending:santa_reveal'); 
            menu.appendChild(btn);
        });
    }

</script>
<div style="position: absolute; bottom: 10px; width: 100%; text-align: center; color: #666; font-size: 12px; pointer-events: none; z-index: 100;">
    Created with Vibe Coding & Gemini AI
</div>
</body>
</html>
